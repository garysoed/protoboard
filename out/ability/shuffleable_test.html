<html><head>
  <base href="../..">
  <title>ability.Shuffleable Unit Tests</title>

  <link rel="import" href="out/testbase.html">

  <link rel="import" href="out/ability/shuffleable.html">
  <link rel="import" href="out/di.html">
  <link rel="import" href="out/service/registry.html">
</head>
<body>
  <script>
  DI
      .with('$registry', Registry => new Registry())
      .with('doc', () => document.currentScript.ownerDocument)
      .run((expect, _, doc, Shuffleable, Utils) => {

  describe('ability.Shuffleable', () => {
    let el;
    let shuffleable;

    beforeEach(done => {
      el = doc.createElement('div');
      shuffleable = new Shuffleable(undefined, undefined, true);
      done();
    });

    describe('#init', () => {
      it('should set the default value if attribute is not set', () => {
        shuffleable.init(el);
        expect($(el).attr(shuffleable.attrName)).to.be.equal('true');
      });
      it('should be noop if the attribute is set', () => {
        $(el).attr(shuffleable.attrName, 'false');
        shuffleable.init(el);
        expect($(el).attr(shuffleable.attrName)).to.be.equal('false');
      });
    });

    describe('#trigger', () => {
      let children = [];
      let origRandom;

      beforeEach(done => {
        children.push(doc.createElement('div'));
        children.push(doc.createElement('a'));
        children.push(doc.createElement('p'));

        children.forEach(function(child) {
          el.appendChild(child);
        });

        origRandom = Math.random;
        let ordering = [1, 3, 2];
        Math.random = () => { return ordering.pop(); };
        done();
      });

      it('should shuffle if enabled', () => {
        $(el).attr('pb-shuffleable', 'true');
        shuffleable.trigger(el);
        expect(Utils.toArray(el.children)).to.be.eql([children[2], children[0], children[1]]);
      });
      it('should be noop if disabled', () => {
        $(el).attr('pb-shuffleable', 'false');

        _.spy(Math, 'random');
        shuffleable.trigger(el);
        expect(Math.random).called().to.be.equal(0);
      });
      it('should be noop if attribute value is bad', () => {
        $(el).attr('pb-shuffleable', 'invalid');
        
        _.spy(Math, 'random');
        shuffleable.trigger(el);
        expect(Math.random).called().to.be.equal(0);
      });

      afterEach(done => {
        Math.random = origRandom;
        done();
      });
    });

    afterEach(done => {
      _.reset();
      done();
    });
  });
  });
  </script>
</body></html>