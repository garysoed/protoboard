<!DOCTYPE html>
<html>
  <base href="../..">
  <head>
    <link rel="import" href="out/bootstrap.html">
    <link rel="import" href="out/component/card.html">
    <link rel="import" href="out/di.html">
    <link rel="import" href="out/region/deck.html">
    <link rel="import" href="out/region/hand.html">
    <link rel="import" href="out/region/rect.html">
    <link rel="import" href="out/ui/preview.html">
    <link rel="import" href="out/ui/previewer.html">
    <link rel="import" href="out/ui/template.html">
    <link rel="stylesheet" href="ex/gazer/gazer.css">

    <script>
      var gz = {};
    </script>
    <script src="ex/gazer/gz-data.js"></script>
    <script>
      gz.plain = {
        'Energy Orb': 2,
        'Mind Link': 2,
        'Bot': 2,
        'Meditate': 2
      };
      gz.air = gz.cards.Air;
      gz.fire = gz.cards.Fire;
      gz.water = gz.cards.Water;
      gz.earth = gz.cards.Earth;

      gz.base = gz.cards.Base;
      gz.base.mind_link = gz.base[2];
      gz.base.bot = gz.base[1];
      gz.base.energy_orb = gz.base[0];
      gz.base.meditate = gz.base[3];


      gz.player1 = [];
      gz.player2 = [];
      for (var name in gz.plain) {
        var card = null;
        gz.base.forEach(function(candidate) {
          if (candidate.name === name) {
            card = candidate;
          }
        });
        if (!card) {
          throw name + ' cannot be found';
        }

        var clone = JSON.parse(JSON.stringify(card));
        clone.count = gz.plain[name];
        gz.player1.push(clone);
        gz.player2.push(clone);
      }
    </script>

    <template id="cardTemplate">
      {{#pb-for 0 count 1}}
      <pb-c-card class="{{element}}"
                 flippable-active="{{@root.showfront}}">
        <div class="pb-back"></div>
        <div class="pb-front">
          <div>{{name}}</div>
          {{#if life}}
          <input type="number">
          {{#if attack}}{{attack}} / {{armor}}{{/if}}
          {{/if}}
          <pb-u-preview>
            <h1>{{name}}</h1>
            <h2>{{type}}, {{element}}</h2>
            <h2>{{#if life}}L: {{life}}{{/if}}{{#if attack}} A: {{attack}} D: {{armor}}{{/if}}</h2>
            <h2>Cost: {{cost}}</h2>
            <main>{{description}}</main>
          </pb-u-preview>
        </div>
      </pb-c-card>
      {{/pb-for}}
    </template>

    <template cards>
      {{#each cards}}
        {{> gz-card}}
      {{/each}}
    </template>

    <script>
      Handlebars.registerPartial('gz-card', document.querySelector('#cardTemplate').innerHTML);
    </script>
  </head>
  <body>
    <section id="top-section">
      <section id="active-area">

        <section id="draft">
          <section id="rift">
            <pb-r-deck id="riftdeck">
              <pb-u-template id="rift-air"
                  template="template[cards]"
                  data-cards="gz.air"
                  data-showfront="false"></pb-u-template>
              <pb-u-template id="rift-earth"
                  template="template[cards]"
                  data-cards="gz.earth"
                  data-showfront="false"></pb-u-template>
              <pb-u-template id="rift-fire"
                  template="template[cards]"
                  data-cards="gz.fire"
                  data-showfront="false"></pb-u-template>
              <pb-u-template id="rift-water"
                  template="template[cards]"
                  data-cards="gz.water"
                  data-showfront="false"></pb-u-template>
            </pb-r-deck>

            <section id="riftchoice">
              <pb-r-deck></pb-r-deck>
              <pb-r-deck></pb-r-deck>
              <pb-r-deck></pb-r-deck>
              <pb-r-deck></pb-r-deck>
            </section>
          </section>

          <section id="environment">
            <section id="staples">
              <template>
              {{#each cards}}
              <pb-r-deck>
                {{> gz-card}}
              </pb-r-deck>
              {{/each}}
              </template>

              <pb-u-template template="#staples template" data-cards="gz.base" data-showfront="true"></pb-u-template>
            </section>
            <pb-r-deck id="riftdiscard"></pb-r-deck>
          </section>
        </section>

        <section id="playarea">
          <pb-r-rect></pb-r-rect>
        </section>
      </section>

      <pb-u-previewer></pb-u-previewer>
    </section>

    <section id="bottom-section" class="player1">
      <ul>
        <li class="player1">Player 1 <input type="number"></li>
        <li class="player2">Player 2 <input type="number"></li>
      </ul>
      <section id="switcher">
        <section class="playerarea" id="player1area">
          <section class="hand">
            <pb-r-deck class="discard"></pb-r-deck>
            <pb-r-deck class="deck" show-count="true" data-count="5">
              <pb-u-template id="player1-template"
                  template="template[cards]"
                  data-cards="gz.player1"
                  data-showfront="false"></pb-u-template>
            </pb-r-deck>
            <div class="decksize"></div>
            <pb-r-hand></pb-r-hand>
          </section>
          <section class="buttons">
            <button class="shuffle">Shuffle</button>
            <button class="draw">Draw 4</button>
          </section>
        </section>
        <section class="playerarea" id="player2area">
          <section class="hand">
            <pb-r-deck class="discard"></pb-r-deck>
            <pb-r-deck class="deck">
              <pb-u-template id="player2-template"
                  template="template[cards]"
                  data-cards="gz.player2"
                  data-showfront="false"></pb-u-template>
            </pb-r-deck>
            <div class="decksize"></div>
            <pb-r-hand></pb-r-hand>
          </section>
          <section class="buttons">
            <button class="shuffle">Shuffle</button>
            <button class="draw">Draw 4</button>
          </section>
        </section>
      </section>
    </section>

    <script>
      DI
          .run(function(Abilities, Bootstrap, Config, Key, Shuffleable, Toggleable, Utils) {

        Config.add('pb-c-card', new Toggleable('flippable', new Key('f'), true));
        Bootstrap.run(document);

        var deckPromise = Promise.all([
          Utils.watch(function() {
            return document.querySelector('#rift-air') === null;
          }),
          Utils.watch(function() {
            return document.querySelector('#rift-fire') === null;
          }),
          Utils.watch(function() {
            return document.querySelector('#rift-water') === null;
          }),
          Utils.watch(function() {
            return document.querySelector('#rift-earth') === null;
          })
        ]).then(function() {
          Abilities.of(document.querySelector('#riftdeck')).trigger('shuffleable');
        });

        var player1Promise = Utils.watch(function() {
          return document.querySelector('#player1-template') === null;
        }).then(function() {
          var deck = document.querySelector('#player1area .deck');
          Abilities.of(document.querySelector('#player1area .deck')).trigger('shuffleable');

          var observer = new MutationObserver(function() {
            document.querySelector('#player1area .decksize').innerText = deck.children.length;
          });
          document.querySelector('#player1area .decksize').innerText = deck.children.length
          observer.observe(deck, { childList: true });
        });

        var player2Promise = Utils.watch(function() {
          return document.querySelector('#player2-template') === null;
        }).then(function() {
          var deck = document.querySelector('#player2area .deck');
          Abilities.of(document.querySelector('#player2area .deck')).trigger('shuffleable');

          var observer = new MutationObserver(function() {
            document.querySelector('#player2area .decksize').innerText = deck.children.length;
          });
          document.querySelector('#player2area .decksize').innerText = deck.children.length
          observer.observe(deck, { childList: true });
        });

        Promise.all([ deckPromise, player1Promise, player2Promise ])
            .then(function() {
              Utils.toArray(document.querySelectorAll('input')).forEach(function(el) {
                el.addEventListener('click', function(e) {
                  e.stopPropagation();
                });
                el.addEventListener('mousedown', function(e) {
                  e.stopPropagation();
                });
              });
            });

        var bottom = document.querySelector('#bottom-section');
        document.querySelector('#bottom-section li.player1').addEventListener('click', function() {
          bottom.classList.toggle('player1');
          bottom.classList.remove('player2');
        });
        document.querySelector('#bottom-section li.player2').addEventListener('click', function() {
          bottom.classList.toggle('player2');
          bottom.classList.remove('player1');
        });

        Utils.toArray(document.querySelectorAll('.playerarea')).forEach(function(area) {
          var deck = area.querySelector('.deck');
          var discard = area.querySelector('.discard');
          var hand = area.querySelector('pb-r-hand');

          area.querySelector('button.shuffle').addEventListener('click', function() {
            Abilities.of(discard).trigger('shuffleable');

            // Flip all the children and move them to the bottom of the deck.
            Utils.toArray(discard.children).forEach(function(child) {
              $(child).attr('flippable-active', false);
              deck.insertBefore(child, deck.firstElementChild);
            });

            // TODO(gs): Add "add to bottom" to card
          });

          area.querySelector('button.draw').addEventListener('click', function() {
            for (var i = 0; i < 4 && deck.childElementCount > 0; i++) {
              var child = deck.lastElementChild;
              hand.appendChild(child);
              $(child).attr('flippable-active', true);
            }
          });
        });
      });
    </script>
  </body>
</html>