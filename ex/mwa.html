<!doctype html>
<html>
  <base href="..">
  <head>
    <link rel="import" href="src/component/card.html">
    <link rel="import" href="src/surface/rectgrid.html">
    <link rel="import" href="src/region/deck.html">
    <link rel="import" href="src/region/rect.html">
    <link rel="import" href="src/pbelement.html">
    <link rel="import" href="src/utils.html">
    <link rel="import" href="src/template.html">

    <link rel="stylesheet" type="text/css" href="out/themes/main.css">

    <script src="node_modules/jquery/dist/jquery.js"></script>
  </head>

  <body class="pb-debug">
    <style>
      #main {
        display: flex;
      }

      #board-area {
        margin-right: 20px;
      }

      #deck-area {
        flex: 1;
      }

      pb-s-rectgrid .time {
        width: 100px;
      }

    </style>

    <script>
      window['chars'] = ['p1', 'p2', 'red', 'blue', 'dud'];
      window['events'] = {
        'red': {
          '-2': 3,
          '-1': 1,
          '0': 2,
          '1': 1,
          '2': 3
        },

        'blue': {
          '-2': 2,
          '-1': 2, 
          '0': 2,
          '1': 2,
          '2': 2
        },
        
      };

      window['times'] = [];
      for (var i = 0; i < 10; i++) {
        window['times'].push((i + 1) + ' PM');
      }
    </script>

    <section id="main">
      <section id="board-area">
        <pb-s-rectgrid pb-row="10" pb-col="6" id="board">
          <pb-template data-times="times">
            {{#each times}}
            <div class="time" pb-row="{{@index}}" pb-col="0">{{this}}</div>
            {{/each}}
          </pb-template>
        </pb-s-rectgrid>
      </section>

      <section id="deck-area">
        <pb-r-deck id="chardeck">
          <pb-template data-chars="chars">
            {{#each chars}}
            <pb-c-card class="char">
              <div class="pb-front" draggable="true">{{this}}</div>
              <div class="pb-back" draggable="true"></div>
            </pb-c-card>
            {{/each}}
          </pb-template>
        </pb-r-deck>

        <pb-r-deck id="eventdeck">
          <pb-template data-events="events">
          {{#each events}}
            {{#each this}}
              {{#pb-copy this}}
                <pb-c-card class="event {{@../key}}">
                  <div class="pb-front" draggable="true">{{@../key}} {{this}}</div>
                  <div class="pb-back" draggable="true"></div>
                </pb-c-card>
                {{/pb-copy}}
            {{/each}}
          {{/each}}
          </pb-template>
        </pb-r-deck>
      </section>
    </section>

    <script>
      var board = document.querySelector('#board');
      var chardeck = document.querySelector('#chardeck');
      var eventdeck = document.querySelector('#eventdeck');

      function createBoardCells(board) {
        // Create the board's cells.
        for (var r = 0; r < 10; r++) {
          for (var c = 1; c < 6; c++) {
            var el = document.createElement('pb-r-rect');
            $(el)
                .attr('pb-row', r)
                .attr('pb-col', c)
                .appendTo(board);
          }
        }
      };

      function shuffle(element) {
        element.shuffle();
      }

      function distributeCards() {
        // Distribute the starting 
      }

      var boardCreatedPromise = pb.Utils.waitFor(board, 'isCreated', true);
      var chardeckCreatedPromise = pb.Utils.waitFor(chardeck, 'isCreated', true);
      var eventdeckCreatedPromise = pb.Utils.waitFor(eventdeck, 'isCreated', true);

      // Sequence all the promises.
      Promise.all([
        boardCreatedPromise.then(createBoardCells),
        chardeckCreatedPromise.then(shuffle),
        eventdeckCreatedPromise.then(shuffle)
      ]).then(distributeCards);
    </script>
  </body>
</html>