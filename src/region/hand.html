<base href="..">

<link rel="import" href="ability/abilities.html">
<link rel="import" href="ability/droppable.html">
<link rel="import" href="ability/helpable.html">
<link rel="import" href="check.html">
<link rel="import" href="region/region.html">
<link rel="import" href="service/config.html">
<link rel="import" href="service/move.html">
<link rel="import" href="third_party/di.html">
<link rel="import" href="trigger/key.html">
<link rel="import" href="utils.html">

<template>
  <style>
    #root {
      border: var(--border);
      position: relative;
    }

    #content {
      display: flex;
      justify-content: space-between;
      overflow: hidden;
    }

    ::content > *:hover {
      filter: drop-shadow(var(--drop-shadow-layer-1));
    }

    ::content > *:last-child {
      flex-shrink: 0;
    }
  </style>

  <div id="root">
    <div id="content">
      <content></content>
    </div>
  </div>
</template>

<script>
DI
    .prefix('pb')
    .constant('doc', document.currentScript.ownerDocument)
    .with('template', ['=', doc => doc.querySelector('template')])
    .bind('region.Hand', [
        '=',
        'ability.=',
        '=',
        'service.=',
        'ability.=',
        'ability.=',
        'trigger.=',
        'service.=',
        'region.=',
        '=',
        '=',
        '=',
          ($registry,
          Abilities,
          Check,
          Config,
          Droppable,
          Helpable,
          Key,
          Move,
          Region,
          Utils,
          doc,
          template) => {

  const EL_NAME = 'pb-r-hand';

  class ReorderableDroppable extends Droppable {

    /**
     * This ability works with conjunction of {{#crossLink "ability.Pickable"}}{{/crossLink}}.
     * Elements with this ability adds the picked element as its child element when triggered.
     * The position of the dropped element depends on the mouse position when the trigger
     * occured.
     *
     * @constructor
     * @class region.Hand.ReorderableDroppable
     * @param {string} [name=pb-droppable] Name of the ability.
     * @param {trigger.Trigger} [defaultTrigger=trigger.Key] Default trigger for the ability.
     * @param {boolean} [defaultEnabled=true] True iff the ability should be enabled by default.
     * @extends ability.Droppable
     */
    constructor(name = 'pb-droppable', defaultTrigger = new Key('d'), defaultEnabled = true) {
      super(name, defaultTrigger, defaultEnabled);
    }

    /**
     * Drops the element added to {{#crossLink "service.Move"}}{{/crossLink}} as a child of the
     * given element. The position of the dropped child depends on the position of the mouse at the
     * trigger time relative to the other children.
     *
     * @method doTrigger
     * @param {Element} el The element to drop the picked element into.
     */
    doTrigger(el) {
      let movedElement = Move.movedElements.values().next().value;
      if (movedElement) {
        // Go through every children and find the index that the element should be.
        let dropped = false;
        for (let child of Utils.toArray(el.children)) {
          let rect = child.getBoundingClientRect();
          if (!dropped && rect.left + rect.width / 2 > Move.mouseX) {
            dropped = true;
            el.insertBefore(movedElement, child);
          }
        }

        if (!dropped) {
          el.appendChild(movedElement);
        }
      }
    }
  }

  /**
   * Represents a hand. Like other {{#crossLink region.Region}}{{/crossLink}} elements, the children
   * are considered to be in the hand. A hand allows the user to reorder the child elements,
   * depending on where a child element is dropped.
   *
   * ```html
   * <!-- Hand with two tokens -->
   * <pb-r-deck>
   *   <pb-c-token id="token1">
   *     <div>Token 1</div>
   *   </pb-c-token>
   *   <pb-c-token id="token2">
   *     <div>Token 2</div>
   *   </pb-c-token>
   * </pb-r-deck>
   * ```
   *
   * Supported abilities:
   * - {{#crossLink "region.Hand.ReorderableDroppable"}}drop{{/crossLink}}
   *
   * @class region.Hand
   * @extends region.Region
   */
  class Hand extends Region {

    /**
     * Called when the element is created.
     *
     * @method createdCallback
     */
    createdCallback() {
      super.createdCallback();
      this.createShadowRoot()
          .appendChild(Utils.activateTemplate(template, doc));

      this.attachedCallback();
    }

    /**
     * Called when the element is attached to the document.
     *
     * @method attachedCallback
     */
    attachedCallback() {
      super.attachedCallback();
    }

    /**
     * Called when the element is detached from the document.
     *
     * @method detachedCallback
     */
    detachedCallback() {
      super.detachedCallback();
    }
  }


  Config.add(
      EL_NAME,
      new Helpable('help'),
      new ReorderableDroppable('drop', new Key('d'), true));
  $registry.add(EL_NAME, Hand.prototype);

  if (window['TEST_MODE']) {
    Hand.ReorderableDroppable = ReorderableDroppable;
  }

  return Hand;
}]);
</script>