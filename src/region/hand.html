<base href="../..">

<link rel="import" href="out/ability/abilities.html">
<link rel="import" href="out/ability/droppable.html">
<link rel="import" href="out/di.html">
<link rel="import" href="out/region/region.html">
<link rel="import" href="out/service/dragdrop.html">
<link rel="import" href="out/utils.html">

<link rel="stylesheet" type="text/css" href="out/region/hand.css">

<template>
  <div id="root">
    <div id="content">
      <content></content>
    </div>
  </div>
</template>

<script>
DI.bind('pb_region_Hand', (Abilities, DragDrop, Droppable, Region, Utils) => {

/**
 * @class region.Hand
 * @extends region.Region
 */

let doc = document.currentScript.ownerDocument;
let template = doc.querySelector('template');

const EL_NAME = 'pb-r-hand';

class ReorderableDroppable extends Droppable {
  constructor(defaultValue) {
    super(defaultValue);
  }

  trigger(el, event) {
    el.classList.remove('pb-over');
    let lastDraggedEl = DragDrop.lastDraggedEl;
    if (!lastDraggedEl) {
      return;
    }

    // Go through every children and find the index that the element should be.
    let dropped = false;
    for (let child of Utils.toArray(el.children)) {
      let rect = child.getBoundingClientRect();
      if (!dropped && rect.left + rect.width / 2 > event.clientX) {
        dropped = true;
        el.insertBefore(lastDraggedEl, child);
      }
    }

    if (!dropped) {
      el.appendChild(lastDraggedEl);
    }
  }
}

export default class Hand extends Region {

  /**
   * Called when the element is created.
   *
   * @method createdCallback
   */
  createdCallback() {
    super.createdCallback();
    this.createShadowRoot()
        .appendChild(Utils.activateTemplate(template, doc));

    this.attachedCallback();
  }

  /**
   * Called when the element is attached to the document.
   *
   * @method attachedCallback
   */
  attachedCallback() {
    super.attachedCallback();
  }

  /**
   * Called when the element is detached from the document.
   *
   * @method detachedCallback
   */
  detachedCallback() {
    super.detachedCallback();
  }
}


let droppable = new ReorderableDroppable(true);
document.registerElement(EL_NAME, {
  prototype: Abilities.config(
      Hand,
      {},
      droppable).prototype
});

if (window['TEST_MODE']) {
  Hand.ReorderableDroppable = ReorderableDroppable;
}

return Hand;

});
</script>