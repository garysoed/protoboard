<base href="../..">

<link rel="import" href="out/ability/abilities.html">
<link rel="import" href="out/ability/droppable.html">
<link rel="import" href="out/ability/pickable.html">
<link rel="import" href="out/di.html">
<link rel="import" href="out/region/region.html">
<link rel="import" href="out/service/move.html">
<link rel="import" href="out/trigger/click.html">
<link rel="import" href="out/trigger/key.html">
<link rel="import" href="out/utils.html">

<link rel="stylesheet" type="text/css" href="out/region/bag.css">

<template id="main">
  <div id="root">
    <content></content>
  </div>
</template>

<template id="placeholder">
  <div class="pb-placeholder">???</div>
</template>

<script>
DI
    .constant('doc', document.currentScript.ownerDocument)
    .with('template', doc => doc.querySelector('template#main'))
    .with('placeHolderTmp', doc => doc.querySelector('template#placeholder'))
    .bind('pb_region_Bag', (
        $registry,
        Abilities,
        Click,
        Droppable,
        Key,
        Move,
        Pickable,
        Region,
        Utils,
        doc,
        template,
        placeHolderTmp) => {

  /**
   * A collection of components. You cannot see the component until you drag one out of it.
   *
   * To make a bag, create a `pb-r-bag` element. You can override the content of the placeholder by
   * creating a child element with a `pb-placeholder-content` attribute. This element will be used for
   * the placeholder content.
   *
   * ```html
   * <!-- Example: Create a bag with a place holder token displaying "SECRET!!" -->
   * <pb-r-bag>
   *   <div pb-placeholder-content>SECRET!!</div>
   * </pb-r-bag>
   * ```
   *
   * Supported abilitie:
   * - [[Droppable|ability.Droppable]]: Default enabled.
   * 
   * @class region.Bag
   * @extends region.Region
   */

  const EL_NAME = 'pb-r-bag';
  const ATTR_PLACEHOLDER = 'pb-placeholder';
  const ATTR_PLACEHOLDER_CONTENT = 'pb-placeholder-content';

  // Private symbols
  const __placeHolderEl__ = Symbol('placeHolderEl');

  class RandomPickable extends Pickable {

    constructor(name = 'pb-pickable', defaultTrigger = new Click(), defaultEnabled = true) {
      super(name, defaultTrigger, defaultEnabled);
    }

    trigger(el, event) {
      let candidates = Utils.toArray(el.children)
          .filter(child => $(child).attr(ATTR_PLACEHOLDER) === undefined);
      let moved = candidates[Math.round(Math.random() * (candidates.length - 1))];
      Move.add(moved, event);
    }
  }

  class Bag extends Region {

    /**
     * Called when the element is created.
     *
     * @method createdCallback
     */
    createdCallback() {
      super.createdCallback();

      this.createShadowRoot().appendChild(Utils.activateTemplate(template, doc));

      this[__placeHolderEl__] = this.querySelector(`[${ATTR_PLACEHOLDER}]`);

      if (!this[__placeHolderEl__]) {
        let placeHolderContent = this.querySelector(`[${ATTR_PLACEHOLDER_CONTENT}]`) ||
            Utils.activateTemplate(placeHolderTmp, doc);

        this[__placeHolderEl__] = doc.createElement('div');
        this[__placeHolderEl__].appendChild(placeHolderContent);
        $(this[__placeHolderEl__]).attr(ATTR_PLACEHOLDER, '');
        this.insertBefore(this[__placeHolderEl__], this.lastChild);
      }

      this.attachedCallback();
    }
  }

  Bag.prototype[__placeHolderEl__] = null;

  Abilities.of(Bag.prototype)
      .add(new Droppable('droppable', new Key('d')))
      .add(new RandomPickable('pickable', new Key('q')));

  $registry.add(EL_NAME, Bag.prototype);

  if (window['TEST_MODE']) {
    Bag.RandomPickable = RandomPickable;
  }

  return Bag;
});
</script>
