<base href="..">

<link rel="import" href="ability/droppable.html">
<link rel="import" href="ability/helpable.html">
<link rel="import" href="ability/selectedpickable.html">
<link rel="import" href="region/region.html">
<link rel="import" href="service/config.html">
<link rel="import" href="service/move.html">
<link rel="import" href="third_party/di.html">
<link rel="import" href="third_party/jquery.html">
<link rel="import" href="trigger/key.html">
<link rel="import" href="utils.html">

<template id="main">
  <style>
    :host {
      height: var(--component-height);
      width: var(--component-width);
    }

    #root {
      outline: var(--border);
      outline-offset: -1px;
      width: 100%;
      height: 100%;
    }

    /* The placeholder */
    ::content > :not([pb-placeholder]) {
      display: none;
    }

    ::content > [pb-placeholder] {
      position: absolute;
      background-color: var(--color-background-accent);
      height: var(--component-height);
      line-height: var(--component-height);
      text-align: center;
      width: var(--component-width);
      outline: var(--border);
      outline-offset: -1px;
      z-index: -1;
    }

    ::content > [pb-placeholder]:only-child {
      display: none;
    }
  </style>

  <div id="root">
    <content></content>
  </div>
</template>

<template id="placeholder">
  <div class="pb-placeholder">???</div>
</template>

<script>
DI
    .prefix('pb')
    .constant('doc', document.currentScript.ownerDocument)
    .with('template', { doc: '=' }, $i => $i.doc.querySelector('template#main'))
    .with('placeHolderTmp', { doc: '=' }, $i => $i.doc.querySelector('template#placeholder'))
    .bind('region.Bag',
        {
          $: '/=',
          $registry: '=',
          doc: '=',
          template: '=',
          placeHolderTmp: '=',
          Chance: '/=',
          Click: 'trigger.=',
          Config: 'service.=',
          Droppable: 'ability.=',
          Helpable: 'ability.=',
          Key: 'trigger.=',
          Move: 'service.=',
          SelectedPickable: 'ability.=',
          Region: 'region.=',
          Utils: '=',
          TEST_MODE: '/=?'
        },
        $i => {

  const EL_NAME = 'pb-r-bag';
  const ATTR_PLACEHOLDER = 'pb-placeholder';
  const ATTR_PLACEHOLDER_CONTENT = 'pb-placeholder-content';

  // Private symbols
  const __placeHolderEl__ = Symbol('placeHolderEl');
  const __selectChild__ = Symbol('selectChild');

  /**
   * A collection of components. You cannot see the component until you drag one out of it.
   *
   * To make a bag, create a `pb-r-bag` element. You can override the content of the placeholder by
   * creating a child element with a `pb-placeholder-content` attribute. This element will be used for
   * the placeholder content.
   *
   * ```html
   * <!-- Example: Create a bag with a place holder token displaying "SECRET!!" -->
   * <pb-r-bag>
   *   <div pb-placeholder-content>SECRET!!</div>
   * </pb-r-bag>
   * ```
   *
   * Supported abilitie:
   * - {{#crossLink "ability.SelectedPickable"}}pickable{{/crossLink}}
   * - {{#crossLink "ability.Droppable"}}droppable{{/crossLink}}
   *
   * @class region.Bag
   * @extends region.Region
   */

  class Bag extends $i.Region {

    /**
     * Called when the element is created.
     *
     * @method createdCallback
     */
    createdCallback() {
      super.createdCallback();

      this.createShadowRoot().appendChild($i.Utils.activateTemplate($i.template, $i.doc));

      this[__placeHolderEl__] = this.querySelector(`[${ATTR_PLACEHOLDER}]`);

      if (!this[__placeHolderEl__]) {
        let placeHolderContent = this.querySelector(`[${ATTR_PLACEHOLDER_CONTENT}]`) ||
            $i.Utils.activateTemplate($i.placeHolderTmp, $i.doc);

        this[__placeHolderEl__] = $i.doc.createElement('div');
        this[__placeHolderEl__].appendChild(placeHolderContent);
        $i.$(this[__placeHolderEl__]).attr(ATTR_PLACEHOLDER, '');
        this.insertBefore(this[__placeHolderEl__], this.lastChild);
      }
    }

    /**
     * The number of elements that users can pick out from the bag.
     *
     * @property pickableChildCount
     * @type number
     * @readonly
     */
    get pickableChildCount() {
      return this.childElementCount - this.querySelectorAll(`[${ATTR_PLACEHOLDER}]`).length;
    }
  }

  Bag.prototype[__placeHolderEl__] = null;

  /**
   * Randomly picks a child of the given element that is not placeholder element.
   *
   * @method __selectChild__
   * @param {Element} el Element whose child should be picked randomly.
   * @return {Element} Child of the given element that is not placeholder element that has been
   *    picked randomly. Or null if no such child exists.
   * @private
   * @static
   */
  Bag[__selectChild__] = function(el) {
    let filtered = $i.Utils.toArray(el.children).filter(
        child => $i.$(child).attr(ATTR_PLACEHOLDER) === undefined);
    return filtered.length > 0 ? $i.Chance.pick(filtered) : null;
  };

  /**
   * Node name of the bag.
   * @property NODE_NAME
   * @type string
   * @final
   * @static
   */
  Bag.NODE_NAME = EL_NAME;

  $i.Config.add(
      EL_NAME,
      new $i.Helpable('help'),
      new $i.Droppable('drop', new $i.Key('d')),
      new $i.SelectedPickable(Bag[__selectChild__], 'pick', new $i.Key('q')));

  $i.$registry.add(EL_NAME, Bag);

  return Bag;
});
</script>
