<base href="..">

<link rel="import" href="net/abstractio.html">
<link rel="import" href="third_party/di.html">

<script>
DIJS
.bind('pb.net.InMemoryIO', require => {
  const AbstractIO = require('pb.net.AbstractIO');

  const __callbacks__ = Symbol('callbacks');
  const __data__ = Symbol('data');
  const __triggerUpdate__ = Symbol('triggerUpdate');

  class InMemoryIO extends AbstractIO {

    /**
     * Implementation of net.AbstractIO that stores data in memory.
     *
     * @constructor
     * @class net.InMemoryIO
     * @extends net.AbstractIO
     */
    constructor() {
      this[__callbacks__] = [];
      this[__data__] = new Map();
    }

    /**
     * Calls all registered callbacks.
     *
     * @method __triggerUpdate__
     * @param {string} path Path that was updated.
     * @param {Any} data The new data in the updated path.
     * @private
     */
    [__triggerUpdate__](path, data) {
      for (let callback of this[__callbacks__]) {
        callback(path, data);
      }
    }

    /**
     * Registers the callback to listen for changes.
     *
     * @method listen
     * @param {Function} callback Callback called when there is a change on the data. This will be
     *    called with two arguments: path of the data changed, and the new value of the data.
     */
    listen(callback) {
      this[__callbacks__].push(callback);
    }

    /**
     * Retrieves the data corresponding to the given path.
     *
     * @method get
     * @param {string} path Path of the object to be retrieved.
     * @return {Promise} Promise that will be resolved with the retrieved data.
     */
    get(path) {
      let stored = this[__data__].get(path);
      return Promise.resolve(stored === undefined ? null : stored);
    }

    /**
     * Sets the data to the given path. Should also call listener callbacks that have been added.
     *
     * @method set
     * @param {string} path Path of the object to set the value of.
     * @param {Any} data Data to set the path's value to.
     * @return {Promise} Promise that will be resolved when setting the value is successful.
     */
    set(path, data) {
      this[__data__].set(path, data);
      this[__triggerUpdate__](path, data);
      return Promise.resolve();
    }
  }

  return InMemoryIO;
});
</script>
