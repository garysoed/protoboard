<base href="..">

<link rel="import" href="net/abstractio.html">
<link rel="import" href="third_party/di.html">

<script>
DIJS
.bind('pb.net.InMemoryIO', require => {
  const AbstractIO = require('pb.net.AbstractIO');

  const __callbacks__ = Symbol();
  const __map__ = Symbol();
  const __triggerUpdate__ = Symbol();

  class InMemoryIO extends AbstractIO {

    /**
     * Implementation of net.AbstractIO that stores data in memory.
     *
     * @constructor
     * @class net.InMemoryIO
     * @extends net.AbstractIO
     */
    constructor() {
      this[__callbacks__] = [];
      this[__map__] = new Map();
    }

    /**
     * Calls all registered callbacks.
     *
     * @method __triggerUpdate__
     * @param {string} path Path that was updated.
     * @param {Any} data The new data in the updated path.
     * @private
     */
    [__triggerUpdate__](path, data) {
      for (let callback of this[__callbacks__]) {
        callback(path, data);
      }
    }

    /**
     * Registers the callback to listen for changes.
     *
     * @method listen
     * @param {Function} callback Callback called when there is a change on the data. This will be
     *    called with two arguments: path of the data changed, and the new value of the data.
     */
    listen(callback) {
      this[__callbacks__].push(callback);
    }

    /**
     * Allocates a new object as a child of the given path. Should also call listener callbacks
     * that have been added.
     *
     * @method add
     * @param {string} path Path to add the new object to.
     * @return {Promise} Promise that will be resolved with the ID of the newly created object.
     */
    add(path) {
      let id = 0;
      while (this[__map__].has(`${path}/${id}`)) {
        id++;
      }

      let newPath = `${path}/${id}`;
      let data = {};
      this[__map__].set(newPath, data);
      this[__triggerUpdate__](newPath, data);

      return Promise.resolve(`${id}`);
    }

    /**
     * Removes the object in the given path. Should also call listener callbacks that have been
     * added.
     *
     * @method remove
     * @param {string} path Path of the object to be removed.
     * @return {Promise} Promise that will be resolved when the removal is successful.
     */
    remove(path) {
      this[__map__].delete(path);
      this[__triggerUpdate__](path, null);
      return Promise.resolve();
    }

    /**
     * Retrieves the data corresponding to the given path.
     *
     * @method get
     * @param {string} path Path of the object to be retrieved.
     * @return {Promise} Promise that will be resolved with the retrieved data.
     */
    get(path) {
      return Promise.resolve(this[__map__].get(path));
    }

    set(path, data) {
      this[__map__].set(path, data);
      this[__triggerUpdate__](path, data);
      return Promise.resolve();
    }
  }

  return InMemoryIO;
});
</script>
