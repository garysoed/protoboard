<base href="..">

<link rel="import" href="ability/ability.html">
<link rel="import" href="check.html">
<link rel="import" href="di.html">
<link rel="import" href="third_party/jquery.html">
<link rel="import" href="utils.html">

<link rel="stylesheet" href="../bower_components/animate.css/animate.min.css">

<script>
DI
    .prefix('pb')
    .bind('ability.Shuffleable', [
        '/', 'ability', '', 'trigger', '',
        ($, Ability, Check, Click, Utils) => {

  // Private symbols.
  const __defaultEnabled__ = Symbol();

  class Shuffleable extends Ability {

    /**
     * Elements with this ability shuffles its children when triggered.
     *
     * @constructor
     * @class ability.Shuffleable
     * @param {string} [name=pb-shuffleable] Name of the ability.
     * @param {trigger.Trigger} [defaultTrigger=trigger.Click] Default trigger for the ability.
     * @param {boolean} [defaultEnabled=true] True iff the ability should be enabled by default.
     * @extends ability.Ability
     */
    constructor(name = 'pb-shuffleable', defaultTrigger = new Click(), defaultEnabled = true) {
      super(name, defaultTrigger);

      this[__defaultEnabled__] = defaultEnabled;
    }

    /**
     * Sets the default configuration for this ability on the given element.
     *
     * @method init
     * @param {Element} el The element to set the default configuration to.
     */
    init(el) {
      super.init(el);

      if ($(el).attr(this.attrName) === undefined) {
        $(el).attr(this.attrName, this[__defaultEnabled__]);
      }
    }

    /**
     * Shuffles the given element's children, if this ability is enabled on the element.
     *
     * @method trigger
     * @param {Element} el Element whose children should be shuffled.
     */
    trigger(el) {
      if (Check($(el).attr(this.attrName)).isBoolean().orUse(false)) {
        let pairs = Utils.toArray(el.children).map(child => [child, Math.random()]);
        pairs.sort((a, b) => Utils.compare(a[1], b[1]));

        let shuffled = pairs.map(pair => pair[0]);
        shuffled.forEach(shuffledEl => {
          el.appendChild(shuffledEl);

          if (shuffledEl.classList.contains('pb-shuffleable-animate')) {
            shuffledEl.classList.remove('pb-shuffleable-animate');
          }
          shuffledEl.classList.add('pb-shuffleable-animate');
        });

        // Animate the deck
        $(el).one(
            'webkitAnimationEnd mozAnimationEnd MSAnimationEnd oanimationend animationend',
            () => {
              el.classList.remove('animated');
              el.classList.remove('wobble');
            });
        el.classList.add('animated');
        el.classList.add('wobble');
      }
    }
  }

  return Shuffleable;
}]);
