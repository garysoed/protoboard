<base href="../..">

<link rel="import" href="out/check.html">
<link rel="import" href="out/di.html">
<link rel="import" href="out/service/move.html">
<link rel="import" href="out/trigger/click.html">

<script>
DI.bind('pb_ability_Droppable', (Ability, Check, Click, Move) => {

  // Private symbols.
  const __defaultEnabled__ = Symbol();

  const __isEnabled__ = Symbol();

  /**
   * Element with this ability can have elements added to pb.service.Move added as a child element
   * when this ability is triggered.
   *
   * @class ability.Droppable
   * @extends ability.Ability
   */
  class Droppable extends Ability {

    /**
     * @constructor
     * @class ability.Droppable
     * @param {string} [name='pb-droppable'] Name of the ability.
     * @param {trigger.Trigger} [defaultTrigger=trigger.Click] Default trigger for the ability.
     * @param {boolean} [defaultEnabled=true] True iff the ability should be enabled by default.
     */
    constructor(name = 'pb-droppable', defaultTrigger = new Click(), defaultEnabled = true) {
      super(name, defaultTrigger);

      this[__defaultEnabled__] = defaultEnabled;
    }

    /**
     * @method __isEnabled__
     * @return {boolean} True iff the ability is enabled.
     * @private
     */
    [__isEnabled__](el) {
      return Check($(el).attr(this.attrName)).isBoolean().orThrows();
    }

    /**
     * @override
     */
    init(el) {
      super.init(el);

      if ($(el).attr(this.attrName) === undefined) {
        $(el).attr(this.attrName, this[__defaultEnabled__]);
      }
    }

    /**
     * @override
     */
    trigger(el) {
      if (this[__isEnabled__](el)) {
        let toRemove = [];
        Move.movedElements.forEach(movedElement => {
          el.appendChild(movedElement);
          toRemove.push(movedElement);
        });
        for (let el of toRemove) {
          Move.remove(el);
        }
      }
    }
  }

  return Droppable;
});
</script>