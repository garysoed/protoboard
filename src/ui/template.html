<base href="..">

<link rel="import" href="third_party/handlebars.html">

<link rel="import" href="check.html">
<link rel="import" href="pbelement.html">
<link rel="import" href="service/config.html">
<link rel="import" href="utils.html">

<script>
DI
    .bind('pb_ui_Template', ($registry, Check, Config, PbElement, Utils, Handlebars) => {

  /**
   * @class ui.Template
   * @extends PbElement
   * @deprecated ui.Generate
   */

  const EL_NAME = 'pb-u-template';

  const ATTR_TEMPLATE = 'pb-template';

  // Private symbols.
  const __getGlobal__ = Symbol();

  class Template extends PbElement {

    [__getGlobal__](path) {
      return path.split('.').reduce((previousValue, currentValue) => {
        if (previousValue) {
          return previousValue[currentValue];
        } else {
          return previousValue;
        }
      }, window);
    }

    /**
     * Called when the element is created
     *
     * @method createdCallback
     */
    createdCallback() {
      super.createdCallback();

      // Get the data
      let dataPromises = [];
      for (let key in this.dataset) {
        let valueStr = this.dataset[key];
        let value = this[__getGlobal__](valueStr) || valueStr;
        if (value instanceof Promise) {
          dataPromises.push(value.then(result => {
            return [key, result];
          }));
        } else {
          dataPromises.push(Promise.resolve([key, value]));
        }
      }

      Promise.all(dataPromises)
          .then(dataArray => {
            let data = Utils.fromArrayOfArrays(dataArray);
            let templateStr = this.ownerDocument
                .querySelector($(this).attr('template'))
                .innerHTML
                .replace('&gt;', '>');
            $(this).replaceWith(Handlebars.compile(templateStr)(data));
          });
    }
  }

  // Use function since Handlebars changes the context of this.
  Handlebars.registerHelper('pb-for', function(from, to, step, options) {
    if (options === undefined) {
      // Shift the args if step is not defined.
      options = step;
      step = 1;
    }
    let rv = '';
    for (let i = Check(from).isInt().orThrows();
        i < Check(to).isInt().orThrows();
        i += Check(step).isInt().orThrows()) {
      let data = Handlebars.createFrame(options.data || {});
      data.index = i;
      rv += options.fn(this, { data: data });
    }
    return rv;
  });

  Config.add(EL_NAME);
  $registry.add(EL_NAME, Template.prototype);

  return Template;
});
</script>
