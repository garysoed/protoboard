<!DOCTYPE html>
<html>
<head>
  <base href="..">
  <title>Grid Unit Tests</title>
  <link rel="import" href="testbase.html">

  <link rel="import" href="third_party/di.html">
  <link rel="import" href="service/config.html">
  <link rel="import" href="service/registry.html">
  <link rel="import" href="grid/grid.html">
</head>
<body>
  <template id="main">
    <div id="root"></div>
  </template>

  <template id="row">
    <div></div>
  </template>

  <template id="tile">
    <content></content>
  </template>
  <script>
  DI
      .prefix('pb')
      .with('$registry', { Registry: 'service.=' }, $i => new $i.Registry())
      .constant('doc', document.currentScript.ownerDocument)
      .with('template', { doc: '=' }, $i => $i.doc.querySelector('template#main'))
      .with('rowTemplate', { doc: '=' }, $i => $i.doc.querySelector('template#row'))
      .with('tileTemplate', { doc: '=' }, $i => $i.doc.querySelector('template#tile'))
      .run(
          {
            _: '/=',
            _M: '/=',
            $: '/=',
            $registry: '=',
            doc: '=',
            expect: '/=',
            template: '=',
            rowTemplate: '=',
            tileTemplate: '=',
            Config: 'service.=',
            Grid: 'grid.='
          },
          $i => {

  describe('Grid', () => {
    let grid;

    before(done => {
      $i.$registry.register($i.doc, $i.Config);
      done();
    });

    beforeEach(done => {
      Object.defineProperty($i.Grid.prototype, 'rootEl', {
        get: function() { return this.shadowRoot.querySelector('#root'); }
      });
      Object.defineProperty($i.Grid.prototype, 'mainTemplate', { get: () => $i.template });
      Object.defineProperty($i.Grid.prototype, 'rowTemplate', { get: () => $i.rowTemplate });
      Object.defineProperty($i.Grid.prototype, 'tileTemplate', { get: () => $i.tileTemplate });

      grid = $i.doc.createElement('pb-g-grid');
      $i.$(grid)
          .attr('row', 2)
          .attr('col', 3);
      Object.setPrototypeOf(grid, $i.Grid.prototype);

      done();
    });

    describe('#created', () => {
      it('should create the rows and cols', () => {
        let childEl = $i.doc.createElement('div');
        $i.$(childEl)
            .attr('pb-row', 1)
            .attr('pb-col', 2);
        grid.appendChild(childEl);
        grid.createdCallback();
        let contentEls = grid.shadowRoot.querySelectorAll('content');
        $i.expect(contentEls.length).to.be.equal(6);

        let correctCellEl = grid.shadowRoot.querySelector('content[pb-row="1"][pb-col="2"]');
        $i.expect(correctCellEl.getDistributedNodes()[0]).to.contain(childEl);
      });

      it('should throw exception if row is not a number', () => {
        let div = $i.doc.createElement('pb-g-rectgrid');
        Object.setPrototypeOf(div, $i.Grid.prototype);
        $i.$(div)
            .attr('row', 'a')
            .attr('col', 1);

        $i.expect(() => div.createdCallback()).to.throw('a');
      });

      it('should throw exception if col is not a number', () => {
        let div = $i.doc.createElement('pb-g-rectgrid');
        Object.setPrototypeOf(div, $i.Grid.prototype);
        $i.$(div)
            .attr('row', 1)
            .attr('col', 'a');

        $i.expect(() => div.createdCallback()).to.throw('a');
      });
    });

    describe('#get', () => {
      it('should return the correct cell', () => {
        let childEl = $i.doc.createElement('div');
        $i.$(childEl)
            .attr('pb-row', 1)
            .attr('pb-col', 2);
        grid.appendChild(childEl);

        grid.createdCallback();
        $i.expect(grid.get(1, 2)).to.be.equal(childEl);
      });

      it('should return null if the cell is invalid', () => {
        grid.createdCallback();
        $i.expect(grid.get(2, 3)).to.not.exist();
      });
    });
  });
  });
  </script>
</body>
