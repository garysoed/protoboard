<!DOCTYPE html>
<html>
<head>
  <base href="../..">
  <title>Inject Unit Tests</title>

  <link rel="import" href="out/inject.html">

  <link rel="import" href="test/testbase.html">
</head>
<body>
  <script>
    'use strict';

    (function() {
      var expect = chai.expect;
      var _ = spies.Spies;

      var doc = document.currentScript.ownerDocument;

      describe('Inject', function() {
        var a_aa = 'a_aa';
        var a_ab = 'a_ab';

        before(function(done) {
          Inject.provide('test_a_aa', function() { return a_aa; });
          Inject.provide('test_a_ab', function() { return a_ab; });
          done();
        });

        describe('#provide', function() {
          it('should inject the correct values', function() {
            var value = 'value';
            var fn = _.spiedFunction();
            Inject.provide('test_value', function(a_aa, ab) {
              fn(a_aa, ab);
              return value;
            });

            expect(fn).calledWith(a_aa, a_ab).at.least(1);
            expect(Inject.get('test_value')).to.be.equal(value);
          });
          it('should throw error when an injected key cannot be found', function() {
            expect(function() {
              Inject.provide('test_fail', function(a) {});
            }).to.throw(/Cannot find/);
          });
        });

        describe('#with', function() {
          it('should inject using the provided local object', function() {
            var value = 'value';
            var fn = _.spiedFunction();
            var abcValue = 123;
            Inject
                .with({'abc': abcValue})
                .provide('test_value', function(abc) {
                  fn(abc);
                  return value;
                });

            expect(fn).calledWith(abcValue).at.least(1);
            expect(Inject.get('test_value')).to.be.equal(value);
          });
          it('should not persist the bound value', function() {
            Inject
                .with({'abc': 'abc'})
                .provide('test_value', function() { return 1; });
            expect(Inject.get('abc')).to.be.undefined();
          });
        });

        describe('#get', function() {
          var value = 2;

          beforeEach(function(done) {
            Inject.provide('test_suffix', function() { return value; });
            done();
          });
          it('should return exact match', function() {
            expect(Inject.get('test_suffix')).to.be.equal(value);
          });
          it('should return suffix match', function() {
            expect(Inject.get('suffix')).to.be.equal(value);
          });
        });

        describe('#getProvider', function() {
          beforeEach(function(done) {
            Inject.provide('test_suffix', function() { return 2; });
            done();
          });

          it('should return exact match', function() {
            expect(Inject.get('test_suffix')).to.be.not.undefined();
          });
          it('should return suffix match', function() {
            expect(Inject.get('suffix')).to.be.not.undefined();
          });
        })

        describe('$Provider', function() {
          describe('#inject', function() {
            it('should inject the correct values', function() {
              var value = 'value';
              var fn = _.spiedFunction();
              Inject.provide('test_provider', function(aa, ab) {
                fn(aa, ab);
                return value;
              });

              Inject.getProvider('test_provider').inject();
              expect(fn).calledWith(a_aa, a_ab).at.least(2);
            });
          });

          describe('#with', function() {
            it('should bind the provided value', function() {
              var newValue = 'newValue';
              var fn = _.spiedFunction();
              Inject.provide('test_provider', function(aa, ab) {
                fn(aa, ab);
                return 'value';
              });

              Inject
                  .getProvider('test_provider')
                  .with('aa', newValue)
                  .inject();
              expect(fn).calledWith(newValue, a_ab).at.least(1);
            });
            it('should not persist the provided value', function() {
              Inject.getProvider('test_a_aa')
                  .with('abc', 'abc')
                  .inject();

              expect(Inject.get('abc')).to.be.undefined();
            });
          });
        });

        afterEach(function(done) {
          _.reset();
          done();
        });
      });
    })();
  </script>
</body>