<!DOCTYPE html>
<html>
<head>
  <base href="..">
  <title>ui.RegistryService Unit Tests</title>

  <link rel="import" href="testbase.html">
  <link rel="import" href="testing/fakeability.html">
  <link rel="import" href="third_party/di.html">
</head>
<body>
<script>
DIJS
.with('pb.data.ConfigService', require => {
  return {
    add() {},
    getAll() {
      return [];
    }
  };
})
.with('pb.ability.Abilities.Builder', require => {
  const Builder = {
    add() {
      return Builder;
    }
  };
  return Builder;
})
.with('pb.ability.Abilities', require => {
  const Builder = require('pb.ability.Abilities.Builder');
  const Abilities = {
    of() {
      return Builder;
    }
  };
  return Abilities;
})
.with('console', require => {
  return {
    warn() { }
  };
})
.run(require => {
  const Abilities = require('pb.ability.Abilities');
  const Builder = require('pb.ability.Abilities.Builder');
  const Config = require('pb.data.ConfigService');
  const console = require('console');
  const FakeAbility = require('pb.testing.FakeAbility');
  const j = require('jasmine');
  const Registry = require('pb.ui.RegistryService');
  const t = require('pb.t');

  describe('ui.RegistryService', () => {
    var ABILITY = new FakeAbility('ability');

    let registry;
    let FakeElement;
    let doc;

    beforeEach(() => {
      registry = new Registry();
      FakeElement = function() {};
      doc = {
        registerElement: j.createSpy('registerElement')
      };
    });

    describe('#add', () => {
      it('should register the given element name and prototype, and register the abilities', () => {
        spyOn(Config, 'getAll').and.returnValue([ABILITY]);
        spyOn(Abilities, 'of').and.callThrough();
        spyOn(Builder, 'add');

        registry.add('el-name', FakeElement);
        registry.register(doc);

        expect(Abilities.of).toHaveBeenCalledWith(FakeElement.prototype);
        expect(Builder.add).toHaveBeenCalledWith(ABILITY);
        expect(doc.registerElement).toHaveBeenCalledWith('el-name', FakeElement);
      });
      it('should warn if there are no configurations for the current element', () => {
        spyOn(Config, 'getAll').and.returnValue(null);
        spyOn(Abilities, 'of');
        spyOn(console, 'warn');

        registry.add('el-name', FakeElement);
        registry.register(doc);

        expect(Abilities.of).not.toHaveBeenCalled();
        expect(console.warn).toHaveBeenCalled();
        expect(doc.registerElement).toHaveBeenCalledWith('el-name', FakeElement);
      });
      it('should throw exception if the element has been registered', () => {
        registry.add('el-name', FakeElement);
        expect(() => registry.add('el-name', function() {})).toThrowError(/el-name/);
      });
      it('should warn if document.registerElement throws an error', () => {
        let errorMessage = 'error message';

        spyOn(Config, 'getAll').and.returnValue(null);
        spyOn(console, 'warn');
        doc.registerElement = () => {
          throw new Error(errorMessage);
        };

        registry.add('el-name', FakeElement);
        registry.register(doc);

        expect(console.warn).toHaveBeenCalledWith(errorMessage);
      });
    });

    describe('#runAtRegister', () => {
      it('should run the given function at register', () => {
        let fn = j.createSpy('fn');
        registry.runAtRegister(fn);
        registry.register(doc);

        expect(fn).toHaveBeenCalledWith(doc, Config);
      });
    });
  });
});
</script>
</body>
