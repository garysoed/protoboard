<!DOCTYPE html>
<html>
<head>
  <base href="..">
  <title>ui.TemplateService Unit Tests</title>

  <link rel="import" href="check.html">
  <link rel="import" href="third_party/di.html">
  <link rel="import" href="ui/templateservice.html">
  <link rel="import" href="testbase.html">
</head>
<body>
<script>
DIJS
.constant('pb.Handlebars', {
  helpers: {},
  registerHelper(name, helper) {
    this.helpers[name] = helper;
  },
  registerPartial() {
    return this;
  }
})
.constant('doc', document.currentScript.ownerDocument)
.run(require => {

  const Check = require('pb.Check');
  const doc = require('doc');
  const forHelper = require('pb.ui.TemplateService.__forHelper__');
  const Handlebars = require('pb.Handlebars');
  const j = require('jasmine');
  const Template = require('pb.ui.TemplateService.__ctor__');

  describe('ui.TemplateService', () => {
    let template;

    beforeEach(() => {
      template = new Template();
    });

    describe('#addPartial', () => {
      it('should register partial to Handlebars', () => {
        let name = 'partialName';
        let el = doc.createElement('div');
        el.innerHTML = '{{&gt; abc}}';

        spyOn(Handlebars, 'registerPartial');

        template.addPartial(name, el);
        expect(Handlebars.registerPartial).toHaveBeenCalledWith(name, '{{> abc}}');
      });
    });

    describe('#addData and #get', () => {
      it('should handle adding data before retrieval', done => {
        let name = 'data';
        let data = {};
        template.addData(name, data);
        template.get(name)
            .then(result => {
              expect(result).toEqual([name, data]);
            })
            .then(done);
      });
      it('should handle adding data after retrieval', done => {
        let name = 'data';
        let data = {};
        template.get(name)
            .then(result => {
              expect(result).toEqual([name, data]);
            })
            .then(done);
        template.addData(name, data);
      });
    });

    describe('$pb-for helper', () => {

      beforeEach(() => {
        Handlebars.createFrame = input => input;
      });

      it('should repeat the inner block a number of times', () => {
        let content = 'content';
        let options = {
          fn: j.createSpy('fn').and.returnValue(content)
        };

        let result = forHelper.call(Handlebars, '0', '5', '2', options);
        expect(result).toEqual(content + content + content);

        expect(options.fn).toHaveBeenCalledWith(
            Handlebars, j.objectContaining({ data: { index: 0 } }));
        expect(options.fn).toHaveBeenCalledWith(
            Handlebars, j.objectContaining({ data: { index: 2 } }));
        expect(options.fn).toHaveBeenCalledWith(
            Handlebars, j.objectContaining({ data: { index: 4 } }));
      });
      it('should default step to 1', () => {
        let content = 'content';
        let options = {
          fn: j.createSpy('fn').and.returnValue(content)
        };

        let result = forHelper.call(Handlebars, '0', '2', options);
        expect(result).toEqual(content + content);

        expect(options.fn).toHaveBeenCalledWith(
            Handlebars, j.objectContaining({ data: { index: 0 } }));
        expect(options.fn).toHaveBeenCalledWith(
            Handlebars, j.objectContaining({ data: { index: 1 } }));
      });
    });
  });
});
</script>
</body>
