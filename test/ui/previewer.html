<!DOCTYPE html>
<html>
<head>
  <base href="../..">
  <title>ui.Previewer Unit Tests</title>
  <link rel="import" href="test/testbase.html">
  <link rel="import" href="src/ui/previewer.html">
  <link rel="import" href="src/utils.html">
</head>
<body>
  <script>
    'use strict';

    (function() {
      var expect = chai.expect;
      var _ = spies.Spies;
      var _M = spies.Matchers;
      var PreviewService = pb.service.Preview;
      var Utils = pb.Utils;
      var Events = pb.Events;

      var __onPreviewElChanged__ = Utils.getSymbol(pb.ui.Previewer.prototype, 'onPreviewElChanged');

      var doc = document.currentScript.ownerDocument;

      describe('ui.Previewer', function() {
        describe('#createdCallback', function() {
          it('should create a shadow root', function() {
            var previewer = doc.createElement('pb-u-previewer');
            previewer.createdCallback();
            expect(previewer.shadowRoot).to.exist;
          });
        });

        describe('#attachedCallback', function() {
          it('should observe previewedEl in PreviewService', function() {
            _.spy(Utils, 'observe');
            doc.createElement('pb-u-previewer').attachedCallback();

            expect(Utils.observe).calledWith(PreviewService, 'previewedEl', _M.isA(Function));
          });
        });

        describe('#detachedCallback', function() {
          it('should unobserve in PreviewService', function() {
            var offFn = _.spiedFunction();
            var previewer = doc.createElement('pb-u-previewer');

            _.spy(Events, 'of').overrideReturn({ off: offFn });
            previewer.detachedCallback();

            expect(Events.of).calledWith(PreviewService, previewer).at.least(1);
            expect(offFn).calledWith().at.least(1);
          });
        });

        describe('#__onPreviewElChanged__', function() {
          it('should set the inner HTML of the previewEl', function() {
            var innerHTML = 'test inner HTML';
            PreviewService.previewedEl = { innerHTML: innerHTML };
            
            var previewer = doc.createElement('pb-u-previewer');
            previewer[__onPreviewElChanged__]();
            expect(previewer.innerHTML).to.be.equal(innerHTML);
          });
          it('should clear the inner HTML if the previewEl is null', function() {
            var innerHTML = 'test inner HTML';
            PreviewService.previewedEl = null;

            var previewer = doc.createElement('pb-u-previewer');
            previewer[__onPreviewElChanged__]();
            expect(previewer.innerHTML).to.be.equal('');
          });
        });

        afterEach(function(done) {
          _.reset();
          done();
        });
      });
    })();
  </script>
</body>