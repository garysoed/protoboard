<!DOCTYPE html>
<html>
<head>
  <base href="../..">
  <title>Context Unit Tests</title>
  <link rel="import" href="test/testbase.html">
  <link rel="import" href="src/ui/context.html">
</head>
<body>
  <style>
    #child {
      width: 100px;
      height: 100px;
    }
  </style>

  <div id="parent">
    <pb-u-context id="context">
      <div id="child"></div>
    </pb-u-context>
  </div>
  <script>
    'use strict';

    (function() {
      var expect = chai.expect;
      var _ = spies.Spies;

      var ContextService = pb.service.Context;

      var doc = document.currentScript.ownerDocument;
      var el = doc.querySelector('#context');

      describe('Context', function() {
        describe('#click', function() {
          it('should hide if clicking outside the context', function() {
            _.spy(el, 'hide');

            document.body.click();
            expect(el.hide).calledWith().at.least(1);
          });

          it('should not hide if clicking in the context', function() {
            _.spy(el, 'hide');

            doc.querySelector('#child').click();
            expect(el.hide).called().to.be.equal(0);
          });
        });

        describe('#contextmenu', function() {
          it('should show when contextmenu target is parent element', function() {
            _.spy(el, 'show');

            var event = new Event('contextmenu');
            event.x = 123;
            event.y = 456;
            doc.querySelector('#parent').dispatchEvent(event);
            expect(el.show).calledWith(123, 456).at.least(1);
          });

          it('should not show when contextmenu target is not parent element', function() {
            _.spy(el, 'show');

            document.body.dispatchEvent(new Event('contextmenu'));
            expect(el.show).called().to.be.equal(0);
          });
        })

        describe('#show', function() {
          it('should use top left anchor when there is space', function() {
            _.spy(ContextService, 'setActive');

            el.show(1, 2);

            expect(el.shadowRoot.querySelector('#root').classList.contains('shown')).to.be.true;
            expect(ContextService.setActive).calledWith(el).at.least(1);
          });

          // TODO
          it('should use bottom right anchor when there is no space');
        });

        describe('#hide', function() {
          it('should remove the class', function() {
            el.show();
            el.hide();
            expect(el.shadowRoot.querySelector('#root').classList.contains('shown')).to.be.false;
          });
        });

        describe('#handleContextSwitched', function() {
          it('should hide if the active context is a different element', function() {
            var active = {};

            _.spy(el, 'hide');
            _.spy(ContextService, 'getActive').overrideReturn(active);

            $(ContextService).trigger(ContextService.EventType.SWITCHED);

            expect(el.hide).calledWith().at.least(1);
          });
          it('should not hide if the active context is itself', function() {
            _.spy(el, 'hide');
            _.spy(ContextService, 'getActive').overrideReturn(el);

            $(ContextService).trigger(ContextService.EventType.SWITCHED);

            expect(el.hide).called().to.be.equal(0);
          });
        });

        afterEach(function(done) {
          _.reset();
          done();
        });
      });
    })();
  </script>
</body>