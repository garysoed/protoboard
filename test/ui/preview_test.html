<!DOCTYPE html>
<html>
<head>
  <base href="..">
  <title>ui.Preview Unit Tests</title>
  <link rel="import" href="testbase.html">

  <link rel="import" href="third_party/di.html">
  <link rel="import" href="service/config.html">
  <link rel="import" href="service/registry.html">
  <link rel="import" href="ui/preview.html">
</head>
<body>
  <script>
  DI
      .prefix('pb')
      .with('$registry', { Registry: 'service.=' }, $i => new $i.Registry())
      .constant('doc', document.currentScript.ownerDocument)
      .run(
          {
            expect: '/=',
            _: '/=',
            _M: '/=',
            $registry: '=',
            Config: 'service.=',
            Preview: 'ui.=',
            doc: '='
          },
          $i => {

  describe('ui.Preview', () => {
    before(done => {
      $i.$registry.register($i.doc, $i.Config);
      done();
    });

    describe('#attachedCallback', () => {
      it('should listen to mouse enter and leave on parent element', () => {
        let parent = $i.doc.createElement('div');
        let preview = $i.doc.createElement('pb-u-preview');
        parent.appendChild(preview);

        $i._.spy(parent, 'addEventListener');

        preview.attachedCallback();

        $i.expect(parent.addEventListener).calledWith('mouseenter', $i._M.isA(Function)).at.least(1);
        $i.expect(parent.addEventListener).calledWith('mouseleave', $i._M.isA(Function)).at.least(1);
      });
      it('should not crash if there are no parent elements', () => {
        $i.doc.createElement('pb-u-preview').attachedCallback();
      });
    });

    describe('#detachedCallback', () => {
      it('should stop listening to mouse enter and leave from parent element', () => {
        let parent = $i.doc.createElement('div');
        let preview = $i.doc.createElement('pb-u-preview');
        parent.appendChild(preview);

        $i._.spy(parent, 'addEventListener');
        $i._.spy(parent, 'removeEventListener');

        preview.attachedCallback();

        let mouseEnterHandlerMatcher = $i._M.isA(Function);
        let mouseLeaveHandlerMatcher = $i._M.isA(Function);
        $i.expect(parent.addEventListener)
            .calledWith('mouseenter', mouseEnterHandlerMatcher).at.least(1);
        $i.expect(parent.addEventListener)
            .calledWith('mouseleave', mouseLeaveHandlerMatcher).at.least(1);

        preview.detachedCallback();
        $i.expect(parent.removeEventListener)
            .calledWith('mouseenter', mouseEnterHandlerMatcher.matchingArgs[0]).at.least(1);
        $i.expect(parent.removeEventListener)
            .calledWith('mouseleave', mouseLeaveHandlerMatcher.matchingArgs[0]).at.least(1);
      });
      it('should not crash if there are no parent elements', () => {
        $i.doc.createElement('pb-u-preview').detachedCallback();
      });
    });

    afterEach(done => {
      $i._.reset();
      done();
    });
  });
  });
  </script>
</body>
