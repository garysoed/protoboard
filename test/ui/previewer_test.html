<!DOCTYPE html>
<html>
<head>
  <base href="..">
  <title>ui.Previewer Unit Tests</title>
  <link rel="import" href="testbase.html">

  <link rel="import" href="third_party/di.html">
  <link rel="import" href="data/configservice.html">
  <link rel="import" href="testutils.html">
  <link rel="import" href="testing/fakeevents.html">
  <link rel="import" href="ui/previewer.html">
  <link rel="import" href="ui/registryservice.html">
</head>
<body>
<script>
DIJS
.with('pb.$registry', require => new (require('pb.ui.RegistryService'))())
.with('pb.Events', require => {
  const FakeEvents = require('pb.testing.FakeEvents');
  return new FakeEvents();
})
.constant('doc', document.currentScript.ownerDocument)
.run(require => {

  const Config = require('pb.data.ConfigService');
  const doc = require('doc');
  const Events = require('pb.Events');
  const j = require('jasmine');
  const Preview = require('pb.ui.PreviewService');
  const Previewer = require('pb.ui.Previewer');
  const t = require('pb.t');
  const Utils = require('pb.Utils');

  let __onPreviewElChanged__ = t.getSymbol(Previewer.prototype, 'onPreviewElChanged');

  describe('ui.Previewer', () => {
    let previewerEl;

    beforeEach(() => {
      previewerEl = doc.createElement('div');
      Object.setPrototypeOf(previewerEl, Previewer.prototype);
    });

    describe('#attachedCallback', () => {
      it('should observe previewedEl in Preview', () => {
        spyOn(Events, 'on').and.callThrough();
        previewerEl.attachedCallback();

        expect(Events.on)
            .toHaveBeenCalledWith('jquery', Preview.Events.ELEMENT_CHANGED, j.any(Function));
      });
    });

    describe('#detachedCallback', () => {
      it('should unobserve in Preview', () => {
        let offFn = j.createSpy('offFn');

        spyOn(Events, 'of').and.returnValue({ off: offFn });
        previewerEl.detachedCallback();

        expect(Events.of).toHaveBeenCalledWith(Preview, previewerEl);
        expect(offFn).toHaveBeenCalledWith();
      });
    });

    describe('#__onPreviewElChanged__', () => {
      it('should set the inner HTML of the previewEl', () => {
        let innerHTML = 'test inner HTML';
        Preview.previewedEl = { innerHTML: innerHTML };

        previewerEl[__onPreviewElChanged__]();
        expect(previewerEl.innerHTML).toEqual(innerHTML);
      });
      it('should clear the inner HTML if the previewEl is null', () => {
        let innerHTML = 'test inner HTML';
        Preview.previewedEl = null;

        previewerEl[__onPreviewElChanged__]();
        expect(previewerEl.innerHTML).toEqual('');
      });
    });
  });
});
</script>
</body>
