<!DOCTYPE html>
<html>
<head>
  <base href="..">
  <title>ui.Generate Unit Tests</title>

  <link rel="import" href="data/configservice.html">
  <link rel="import" href="ui/registryservice.html">
  <link rel="import" href="ui/templateservice.html">
  <link rel="import" href="testbase.html">
  <link rel="import" href="testing/fakejquery.html">
  <link rel="import" href="third_party/di.html">
  <link rel="import" href="ui/generate.html">
  <link rel="import" href="utils.html">
</head>
<body>
<script>
DIJS
.constant('doc', document.currentScript.ownerDocument)
.with('pb.JQuery', require => require('pb.testing.FakeJQuery'))
.with('pb.$registry', require => {
  const Registry = require('pb.ui.RegistryService');
  return new Registry();
})
.run(require => {

  const _ = require('spies.Spies');
  const $ = require('pb.JQuery');

  const Config = require('pb.data.ConfigService');
  const doc = require('doc');
  const expect = require('chai.expect');
  const Generate = require('pb.ui.Generate');
  const Promise = require('Promise');
  const Template = require('pb.ui.TemplateService');
  const Utils = require('pb.Utils');

  describe('ui.Generate', () => {
    describe('#createdCallback', () => {
      let generate;

      beforeEach(() => {
        generate = Object.create(Generate.prototype, {
          nodeName: {
            value: 'pb-u-generate'
          }
        });
      });

      it('should replace itself with data registered to ui.TemplateService', () => {
        let dataA = 'a';
        let dataB = 'B';
        let innerHTML =
              '<div>Data A: {{dataA}}</div>'
            + '<div>Data B: {{dataB}}</div>';

        let originalGet = Template.get;
        Template.get = name => {
          if (name === 'dataA') {
            return Promise.resolve(['dataA', dataA]);
          } else if (name === 'dataB') {
            return Promise.resolve(['dataB', dataB]);
          }
        };
        _.spy($, 'attr').overrideReturn('dataA dataB');
        _.spy($, 'replaceWith');
        _.spy(generate, 'querySelector').overrideReturn({ innerHTML: innerHTML });

        return generate.createdCallback()
            .then(() => {
              expect($.replaceWith)
                  .calledWith(`<div>Data A: ${dataA}</div><div>Data B: ${dataB}</div>`)
                  .at.least(1);
              Template.get = originalGet;
            });
      });
    });

    afterEach(() => {
      _.reset();
    });
  });
});
</script>
</body>
