<!DOCTYPE html>
<html>
<head>
  <base href="../..">
  <title>Template Unit Tests</title>
  <link rel="import" href="test/testbase.html">
  <link rel="import" href="src/ui/template.html">
</head>
<body>
  <script>
    'use strict';

    (function() {
      var expect = chai.expect;
      var _ = spies.Spies;
      var _M = spies.Matchers;

      var doc = document.currentScript.ownerDocument;

      describe('Template', function() {
        var handlebar = Handlebars.create();
          
        describe('#createdCallback', function() {
          it('should replace the innerHTML', function() {
            var templateStr = 'Template String';
            var compiledTemplateStr = 'Compiled template string';
            var compiledTemplate = _.spiedFunction().overrideReturn(compiledTemplateStr);
            var promise = { then: _.spiedFunction() };

            _.spy(handlebar, 'compile').overrideReturn(compiledTemplate);
            _.spy(Promise, 'all').overrideReturn(promise);

            pb.ui.Template.register(doc, handlebar);

            var templateEl = $(doc.body)
                .html('<pb-u-template>' + templateStr + '</pb-u-template>')[0];

            expect(Promise.all).calledWith([]).at.least(1);

            var callbackCaptor = _M.isA(Function);
            expect(promise.then).calledWith(callbackCaptor).at.least(1);
            callbackCaptor.matchingArgs[0]([]);

            expect(handlebar.compile).calledWith(templateStr).at.least(1);
            expect(templateEl.innerHTML).to.be.equal(compiledTemplateStr);
          });
          it('should take data as variable name to global', function() {
            window['a'] = { b: 'data' };
            var compiledTemplate = _.spiedFunction().overrideReturn('');
            var promise = { then: _.spiedFunction() };

            _.spy(handlebar, 'compile').overrideReturn(compiledTemplate);
            _.spy(Promise, 'all').overrideReturn(promise);

            pb.ui.Template.register(doc, handlebar);

            var templateEl = $(doc.body) .html('<pb-u-template data-a="a.b"></pb-u-template>')[0];

            expect(Promise.all).calledWith([['a', 'data']]).at.least(1);

            var callbackCaptor = _M.isA(Function);
            expect(promise.then).calledWith(callbackCaptor).at.least(1);
            callbackCaptor.matchingArgs[0]([['a', 'data']]);

            expect(compiledTemplate).calledWith({ a: window['a'].b }).at.least(1);
          });
          it('should take data as string value', function() {
            var data = 'data';
            var compiledTemplate = _.spiedFunction().overrideReturn('');
            var promise = { then: _.spiedFunction() };

            _.spy(handlebar, 'compile').overrideReturn(compiledTemplate);
            _.spy(Promise, 'all').overrideReturn(promise);

            pb.ui.Template.register(doc, handlebar);

            var templateEl = $(doc.body) .html('<pb-u-template data-a="data"></pb-u-template>')[0];

            expect(Promise.all).calledWith([['a', data]]).at.least(1);

            var callbackCaptor = _M.isA(Function);
            expect(promise.then).calledWith(callbackCaptor).at.least(1);
            callbackCaptor.matchingArgs[0]([['a', data]]);

            expect(compiledTemplate).calledWith({a: data}).at.least(1);
          });
          it('should take promise as a value', function() {
            var data = 'data';
            window['a'] = Promise.resolve(data);
            var compiledTemplate = _.spiedFunction().overrideReturn('');
            var promise = { then: _.spiedFunction() };

            _.spy(handlebar, 'compile').overrideReturn(compiledTemplate);
            _.spy(Promise, 'all').overrideReturn(promise);

            pb.ui.Template.register(doc, handlebar);

            var templateEl = $(doc.body) .html('<pb-u-template data-a="a"></pb-u-template>')[0];

            expect(Promise.all).calledWith([['a', window['a']]]).at.least(1);

            var callbackCaptor = _M.isA(Function);
            expect(promise.then).calledWith(callbackCaptor).at.least(1);
            callbackCaptor.matchingArgs[0]([['a', data]]);

            expect(compiledTemplate).calledWith({a: data}).at.least(1);

          });          
        });

        describe('#pb-for', function() {
          var helperFn = null;

          beforeEach(function(done) {
            _.spy(handlebar, 'registerHelper');

            pb.ui.Template.register(doc, handlebar);

            var isAFunction = _M.isA(Function);
            expect(handlebar.registerHelper).calledWith('pb-for', isAFunction).at.least(1);
            helperFn = isAFunction.matchingArgs[0];
            done();
          });

          it('should repeat the inner block a number of times', function() {
            var content = "content";
            var options = {
              fn: _.spiedFunction().overrideReturn(content)
            };

            var result = helperFn.call(handlebar, "0", "5", "2", options);
            expect(result).to.be.equal(content + content + content);

            var isAObject = _M.isA(Object);
            expect(options.fn).calledWith(handlebar, isAObject).to.be.equal(3);

            var indexes = isAObject.matchingArgs.map(function(arg) {
              return arg.data.index;
            });
            expect(indexes).to.be.eql([0, 2, 4]);
          });
          it('should default step to 1', function() {
            var content = "content";
            var options = {
              fn: _.spiedFunction().overrideReturn(content)
            };

            var result = helperFn.call(handlebar, "0", "2", options);
            expect(result).to.be.equal(content + content);

            var isAObject = _M.isA(Object);
            expect(options.fn).calledWith(handlebar, isAObject).to.be.equal(2);

            var indexes = isAObject.matchingArgs.map(function(arg) {
              return arg.data.index;
            });
            expect(indexes).to.be.eql([0, 1]);
          });
        });

        afterEach(function(done) {
          _.reset();
          done();
        });
      });
    })();
  </script>
</body>