<!DOCTYPE html>
<html>
<head>
  <title>Utils Unit Tests</title>
  <link rel="import" href="testbase.html">
</head>
<body>
  <template id="correctTemplate">Correct</template>
  <template id="badTemplate">Wrong</template>

  <script>
    'use strict';

    (function() {
      var Utils = pb.Utils;
      var expect = chai.expect;
      var _ = spies.Spies;
      
      var doc = document.currentScript.ownerDocument;

      describe('Utils', function() {
        describe('#extractTemplate', function() {
          it('should extract the correct template', function() {
            var template = Utils.extractTemplate('#correctTemplate', doc);
            expect(template.textContent).to.be.equal('Correct');
          })
        });

        describe('#nonNullFn', function() {
          it('should return the referenced function if it exists', function() {
            var o = {
              f: function() { return 1; }
            };

            expect(Utils.nonNullFn(o, 'f')).to.be.equal(o.f);
          });

          it('should return noop function if it does not exist', function() {
            expect(Utils.nonNullFn({}, 'fn')()).to.be.undefined;
          });
        });

        describe('#observe', function() {
          var o = {a: 1, b: 2};

          it('should listen to a specific property when given the name', function() {
            var handler = _.spiedFunction();
            _.spy(Object, 'observe');

            Utils.observe(o, 'a', handler);
            var isAFunction = Matchers.isA(Function);
            expect(Object.observe).calledWith(o, isAFunction).at.least(1);

            // Emulate a change event on the listened property.
            var changeA = {
              name: 'a',
              type: 'type',
              oldValue: 'oldValue'
            };

            var changeB = {
              name: 'b',
              type: 'type',
              oldValue: 'oldValue'
            };
            isAFunction.matchingArgs[0]([changeA, changeB]);
            expect(handler).calledWith(changeA.name, changeA.type, changeA.oldValue).at.least(1);
            expect(handler).calledWith(changeB.name, Matchers.any(), Matchers.any()).equal(0);
          });
          it('should listen to all properties when not given any names', function() {
            var handler = _.spiedFunction()
            _.spy(Object, 'observe');

            Utils.observe(o, null /* property */, handler);
            var isAFunction = Matchers.isA(Function);
            expect(Object.observe).calledWith(o, isAFunction).at.least(1);

            // Emulate a change event on the listened property.
            var changeA = {
              name: 'a',
              type: 'typeA',
              oldValue: 'oldValueA'
            };

            var changeB = {
              name: 'b',
              type: 'typeB',
              oldValue: 'oldValueB'
            };
            isAFunction.matchingArgs[0]([changeA, changeB]);
            expect(handler).calledWith(changeA.name, changeA.type, changeA.oldValue).at.least(1);
            expect(handler).calledWith(changeB.name, changeB.type, changeB.oldValue).at.least(1);
          });
        });

        describe('#waitFor', function() {
          it('should immediate resolve when the property matches', function(done) {
            var o = { a: true };
            var handler = function() {
              done();
            };
            Utils.waitFor(o, 'a', true).then(handler);
          });
          it('should resolve when the property matches', function(done) {
            var o = { a: false };
            var handler = function() {
              done();
            };
            Utils.waitFor(o, 'a', true).then(handler);
            o.a = true;
          });
          it('should resolve when given a function', function(done) {
            var o = { a: 'value' };
            var handler = function() {
              done();
            };
            Utils.waitFor(o, 'a', function(v) { return v === 'value'; }).then(handler);
          });
        });

        describe('#makeGlobal', function() {
          it('should correctly assign the target', function() {
            var target = 'target';
            Utils.makeGlobal('path.to.the.Target', target);
            expect(path.to.the.Target).to.be.equal(target);

            window.a = undefined;
          });
          it('should throw exception when target is duplicated', function() {
            Utils.makeGlobal('a.b.c.Target', {});
            expect(Utils.makeGlobal.bind(Utils, 'a.b.c.Target', {})).to.throw('Target');
          });
        });
      });
    })();
  </script>
</body>
</html>