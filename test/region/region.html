<!DOCTYPE html>
<html>
<head>
  <base href="../..">
  <title>Region Unit Tests</title>
  <link rel="import" href="test/testbase.html">
</head>
<body>
  <script>
    'use strict';

    (function() {
      var Region = pb.region.Region;
      var DragDrop = pb.service.DragDrop;
      var Distribute = pb.service.Distribute;
      var expect = chai.expect;
      var _ = spies.Spies;

      var doc = document.currentScript.ownerDocument;

      describe('Region', function() {
        describe('#attachedCallback', function() {
          it('should handle dragover', function() {
            var r = new Region();
            _.spy(r, 'addEventListener').overrideReturn();

            var isAFunction = Matchers.isA(Function);
            r.attachedCallback();

            expect(r.addEventListener).calledWith('dragover', isAFunction).at.least(1);

            var handler = isAFunction.matchingArgs[0];
            var stubEvent = _.stub(Event);
            _.spy(stubEvent);
            handler.call(r, stubEvent);

            expect(stubEvent.preventDefault).calledWith().at.least(1);
            expect(stubEvent.dropEffect).to.be.equal('move');
          });
          it('should handle dragenter', function() {
            var r = new Region();
            r.classList = _.stub(DOMTokenList);

            _.spy(r, 'addEventListener').overrideReturn();
            _.spy(r.classList, 'add');

            var isAFunction = Matchers.isA(Function);
            r.attachedCallback();

            expect(r.addEventListener).calledWith('dragenter', isAFunction).at.least(1);

            // Now fire the event.
            var handler = isAFunction.matchingArgs[0];
            handler.call(r);

            expect(r.classList.add).calledWith('pb-over').at.least(1);
          });
          it('should handle dragleave', function() {
            var r = new Region();
            r.classList = _.stub(DOMTokenList);

            _.spy(r, 'addEventListener').overrideReturn();
            _.spy(r.classList, 'remove');

            var isAFunction = Matchers.isA(Function);
            r.createdCallback();
            r.attachedCallback();

            expect(r.addEventListener).calledWith('dragleave', isAFunction).at.least(1);

            // Now fire the event.
            var handler = isAFunction.matchingArgs[0];
            var stubEvent = _.stub(Event);
            _.spy(stubEvent);
            handler.call(r, stubEvent);

            expect(r.classList.remove).calledWith('pb-over').at.least(1);
          });
          it('should handle drop', function() {
            var r = new Region();
            r.classList = _.stub(DOMTokenList);

            _.spy(r, 'addEventListener').overrideReturn();
            _.spy(r.classList, 'remove');

            var isAFunction = Matchers.isA(Function);
            r.attachedCallback();

            expect(r.addEventListener).calledWith('drop', isAFunction).at.least(1);

            // Now fire the event.
            var lastDraggedEl = {
              attachedCallback: _.spiedFunction()
            };
            DragDrop.dragStart(lastDraggedEl);
            _.spy(r, 'appendChild').overrideReturn();

            var handler = isAFunction.matchingArgs[0];
            handler.call(r);

            expect(r.classList.remove).calledWith('pb-over').at.least(1);
            expect(r.appendChild).calledWith(lastDraggedEl).at.least(1);
            expect(lastDraggedEl.attachedCallback).calledWith().at.least(1);
            expect(DragDrop.lastDraggedEl).to.be.null;
          });
          it('should handle click when Distribute service is active and has next', function() {
            var r = new Region();

            _.spy(r, 'addEventListener').overrideReturn();

            var isAFunction = Matchers.isA(Function);
            r.attachedCallback();

            expect(r.addEventListener).calledWith('click', isAFunction).at.least(1);

            // Call the handler.
            var nextEl = {};
            _.spy(Distribute, 'isActive').overrideReturn(true);
            _.spy(Distribute, 'next').overrideReturn(nextEl);
            _.spy(r, 'appendChild').overrideReturn();

            isAFunction.matchingArgs[0].call(r);

            expect(r.appendChild).calledWith(nextEl).at.least(1);
          });
          it('should ignore click when Distribute service is inactive', function() {
            var r = new Region();

            _.spy(r, 'addEventListener').overrideReturn();

            var isAFunction = Matchers.isA(Function);
            r.attachedCallback();

            expect(r.addEventListener).calledWith('click', isAFunction).at.least(1);

            // Call the handler.
            var origIsActive = pb.service.Distribute.isActive;

            var nextEl = {};
            _.spy(Distribute, 'isActive').overrideReturn(false);
            _.spy(r, 'appendChild').overrideReturn();

            isAFunction.matchingArgs[0].call(r);

            expect(r.appendChild).called().to.be.equal(0);
          });
          it('should ignore click when Distribute service does not have next', function() {
            var r = new Region();

            _.spy(r, 'addEventListener').overrideReturn();

            var isAFunction = Matchers.isA(Function);
            r.attachedCallback();

            expect(r.addEventListener).calledWith('click', isAFunction).at.least(1);

            // Call the handler.
            var nextEl = {};
            _.spy(Distribute, 'isActive').overrideReturn(true);
            _.spy(Distribute, 'next').overrideReturn(null);
            _.spy(r, 'appendChild').overrideReturn();

            isAFunction.matchingArgs[0].call(r);

            expect(r.appendChild).called().to.be.equal(0);
          });
          it('should handle distribute begin', function() {
            var stubClassList = _.stub(DOMTokenList);
            _.spy(stubClassList, 'add');

            var r = new Region();
            r.shadowRoot = _.stub(HTMLShadowElement);
            _.spy(r.shadowRoot, 'querySelector').overrideReturn({ classList: stubClassList });
            _.spy(r, 'addEventListener').overrideReturn();

            r.attachedCallback();
            
            $(Distribute).trigger(Distribute.EventType.BEGIN);

            expect(r.shadowRoot.querySelector).calledWith('#root').at.least(1);
            expect(stubClassList.add).calledWith('pb-distribute').at.least(1);
          });
          it('should handle distribute end', function() {
            var stubClassList = _.stub(DOMTokenList);
            _.spy(stubClassList, 'remove');

            var r = new Region();
            r.shadowRoot = _.stub(HTMLShadowElement);
            _.spy(r.shadowRoot, 'querySelector').overrideReturn({ classList: stubClassList });
            _.spy(r, 'addEventListener').overrideReturn();

            r.attachedCallback();
            
            $(Distribute).trigger(Distribute.EventType.END);

            expect(r.shadowRoot.querySelector).calledWith('#root').at.least(1);
            expect(stubClassList.remove).calledWith('pb-distribute').at.least(1);
          });
          it('should not remove over class if dragenter is > dragleave', function() {
            var r = new Region();
            r.classList = _.stub(DOMTokenList);

            _.spy(r, 'addEventListener').overrideReturn();
            _.spy(r.classList, 'remove');

            var enterHandlerMatcher = Matchers.isA(Function);
            var leaveHandlerMatcher = Matchers.isA(Function);
            r.attachedCallback();

            expect(r.addEventListener).calledWith('dragenter', enterHandlerMatcher).at.least(1);
            expect(r.addEventListener).calledWith('dragleave', leaveHandlerMatcher).at.least(1);

            enterHandlerMatcher.matchingArgs[0].call(r);
            enterHandlerMatcher.matchingArgs[0].call(r);
            leaveHandlerMatcher.matchingArgs[0].call(r);

            expect(r.classList.remove).called().to.be.equal(0);
          });

          afterEach(function(done) {
            DragDrop.dragStart(null);
            $(Distribute).off();
            done();
          });
        });

        afterEach(function(done) {
          _.reset();
          done();
        });
      });
    })();
  </script>
</body>