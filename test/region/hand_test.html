<!DOCTYPE html>
<html>
<head>
  <base href="..">
  <title>region.Hand Unit Tests</title>

  <link rel="import" href="testbase.html">

  <link rel="import" href="di.html">
  <link rel="import" href="region/hand.html">
  <link rel="import" href="service/move.html">
  <link rel="import" href="service/registry.html">
  <link rel="import" href="utils.html">
</head>
<body>
  <script>
  DI
      .prefix('pb')
      .constant('service.Move', {
        movedElements: [],
        mouseX: 0
      })
      .with('$registry', ['service', Registry => new Registry()])
      .constant('doc', document.currentScript.ownerDocument)
      .run(['/', '/', '/', '', 'region', 'service', '', (expect, _, $, doc, Hand, Move, Utils) => {

  describe('region.Hand.ReorderableDroppable', () => {
    describe('#trigger', () => {
      let el;
      let droppable;

      beforeEach(done => {
        el = doc.createElement('div');
        droppable = new Hand.ReorderableDroppable();
        $(el).attr(droppable.attrName, 'true');
        done();
      });

      it('should insert before the correct child', () => {
        let child1 = doc.createElement('div');
        _.spy(child1, 'getBoundingClientRect').overrideReturn({
          left: 10,
          width: 20
        });

        let child2 = doc.createElement('div');
        _.spy(child2, 'getBoundingClientRect').overrideReturn({
          left: 35,
          width: 20
        });

        el.appendChild(child1);
        el.appendChild(child2);
        el.classList.add('pb-over');

        let dragged = doc.createElement('div');

        Move.movedElements = [dragged];
        Move.mouseX = 40;

        droppable.trigger(el);

        expect(Utils.toArray(el.children)).to.be.eql([child1, dragged, child2]);
      });
      it('should insert as the last child if eventX is too far to the right', () => {
        let child1 = doc.createElement('div');
        _.spy(child1, 'getBoundingClientRect').overrideReturn({
          left: 10,
          width: 20
        });

        let child2 = doc.createElement('div');
        _.spy(child2, 'getBoundingClientRect').overrideReturn({
          left: 35,
          width: 20
        });

        el.appendChild(child1);
        el.appendChild(child2);

        let dragged = doc.createElement('div');
        Move.movedElements = [dragged];
        Move.mouseX = 50;

        droppable.trigger(el);

        expect(Utils.toArray(el.children)).to.be.eql([child1, child2, dragged]);
      });
      it('should not crash if there are no last dragged element', () => {
        Move.movedElements = [];
        droppable.trigger(el);
      });
    });
    afterEach(done => {
      _.reset();
      done();
    });
  });
  }]);
  </script>
</body>