<!DOCTYPE html>
<html>
<head>
  <base href="../..">
  <title>region.Hand Unit Tests</title>

  <link rel="import" href="out/testbase.html">

  <link rel="import" href="out/di.html">
  <link rel="import" href="out/region/hand.html">
  <link rel="import" href="out/service/dragdrop.html">
  <link rel="import" href="out/service/registry.html">
  <link rel="import" href="out/utils.html">
</head>
<body>
  <script>
  DI
      .with('$registry', Registry => new Registry())
      .constant('doc', document.currentScript.ownerDocument)
      .run((expect, _, doc, DragDrop, Hand, Utils) => {

  describe('region.Hand.ReorderableDroppable', () => {
    describe('#trigger', () => {
      let el;
      let droppable;

      beforeEach(done => {
        el = doc.createElement('div');
        droppable = new Hand.ReorderableDroppable(true);
        done();
      });

      it('should remove the CSS class, and inserts before the correct child', () => {
        let child1 = doc.createElement('div');
        _.spy(child1, 'getBoundingClientRect').overrideReturn({
          left: 10,
          width: 20
        });

        let child2 = doc.createElement('div');
        _.spy(child2, 'getBoundingClientRect').overrideReturn({
          left: 35,
          width: 20
        });

        el.appendChild(child1);
        el.appendChild(child2);
        el.classList.add('pb-over');

        let dragged = doc.createElement('div');
        DragDrop.dragStart(dragged, 0, 0);

        droppable.trigger(el, {clientX: 40});

        expect(el.classList.contains('pb-over')).to.be.false();
        expect(Utils.toArray(el.children)).to.be.eql([child1, dragged, child2]);
      });
      it('should insert as the last child if eventX is too far to the right', () => {
        let child1 = doc.createElement('div');
        _.spy(child1, 'getBoundingClientRect').overrideReturn({
          left: 10,
          width: 20
        });

        let child2 = doc.createElement('div');
        _.spy(child2, 'getBoundingClientRect').overrideReturn({
          left: 35,
          width: 20
        });

        el.appendChild(child1);
        el.appendChild(child2);

        let dragged = doc.createElement('div');
        DragDrop.dragStart(dragged, 0, 0);

        droppable.trigger(el, {clientX: 50});

        expect(Utils.toArray(el.children)).to.be.eql([child1, child2, dragged]);

      });
      it('should not crash if there are no last dragged element', () => {
        droppable.trigger(el, {});
      });
    });
    afterEach(done => {
      _.reset();
      done();
    });
  });
  });
  </script>
</body>