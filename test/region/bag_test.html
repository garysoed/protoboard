<!DOCTYPE html>
<html>
<head>
  <base href="..">
  <title>Bag Unit Tests</title>

  <link rel="import" href="testbase.html">

  <link rel="import" href="third_party/di.html">
  <link rel="import" href="region/bag.html">
  <link rel="import" href="service/config.html">
  <link rel="import" href="service/move.html">
  <link rel="import" href="service/registry.html">
  <link rel="import" href="testutils.html">
</head>
<body>
  <pb-r-bag id="emptyChildren"></pb-r-bag>
  <pb-r-bag id="hasContent">
    <div pb-placeholder-content>content</div>
  </pb-r-bag>
  <pb-r-bag id="hasPlaceholder">
    <div pb-placeholder>Placeholder</div>
  </pb-r-bag>
  <script>
  DI
      .prefix('pb')
      .with('$registry', ['service.=', Registry => new Registry()])
      .constant('doc', document.currentScript.ownerDocument)
      .run([
          '/=', '/=', '/=', '=', 'region.=', '/=', 'service.=', 'service.=', '=', '=',
          (expect, _, _M, doc, Bag, Chance, Config, Move, t, $registry) => {

  let RandomPickable = Bag.RandomPickable;

  // Private symbols
  let __draggable__ = t.getSymbol(Bag.prototype, 'draggable');
  let __placeHolderEl__ = t.getSymbol(Bag.prototype, 'placeHolderEl');

  describe('Bag', () => {
    before(done => {
      $registry.register(doc, Config);
      done();
    });

    describe('#createdCallback', () => {
      it('should create placeholder and its content if none is specified', () => {
        let el = doc.querySelector('#emptyChildren');
        let placeholder = el.querySelector('[pb-placeholder]');
        expect(placeholder).to.exist();
        expect(placeholder.childElementCount).to.be.at.least(1);
      });
      it('should not create placeholder content if it is specified', () => {
        let el = doc.querySelector('#hasContent');
        let placeholders = el.querySelectorAll('[pb-placeholder]');

        expect(placeholders.length).to.equal(1);

        let placeholder = placeholders.item(0);
        expect(placeholder.querySelector('[pb-placeholder-content]').innerHTML)
            .to.equal('content');
      });
      it('should not create placeholder or its content if placeholder is specified', () => {
        let el = doc.querySelector('#hasPlaceholder');
        let placeholders = el.querySelectorAll('[pb-placeholder]');

        expect(placeholders.length).to.equal(1);

        let placeholder = placeholders.item(0);
        expect(placeholder.innerHTML).to.equal('Placeholder');
      });
    });

    describe('$RandomPickable', () => {
      describe('#trigger', () => {
        it('should randomly pick a child element with no pb-placeholder attribute', () => {
          let el = doc.createElement('div');
          let selectedChild = doc.createElement('div');
          let placeHolderEl = doc.createElement('div');
          let child1 = doc.createElement('div');
          let child2 = doc.createElement('div');
          $(placeHolderEl).attr('pb-placeholder', '');

          el.appendChild(placeHolderEl);
          el.appendChild(child1);
          el.appendChild(selectedChild);
          el.appendChild(child2);

          let pickable = new RandomPickable();

          _.spy(Chance, 'pick').overrideReturn(selectedChild);
          _.spy(Move, 'add');

          pickable.init(el);
          pickable.trigger(el);

          let childrenCaptor = _M.isA(Array);
          expect(Chance.pick).calledWith(childrenCaptor).at.least(1);
          expect(childrenCaptor.matchingArgs[0]).to.be.eql([child1, selectedChild, child2]);

          expect(Move.add).calledWith(selectedChild).at.least(1);
        });
        it('should not crash if there are no children', () => {
          let el = doc.createElement('div');
          let placeHolderEl = doc.createElement('div');
          $(placeHolderEl).attr('pb-placeholder', '');

          _.spy(Move, 'add');

          el.appendChild(placeHolderEl);

          let pickable = new RandomPickable();
          pickable.init(el);
          pickable.trigger(el);
          expect(Move.add).called().to.equal(0);
        });
      });
    });

    afterEach(done => {
      _.reset();
      done();
    });
  });
  }]);
  </script>
</body>