<!DOCTYPE html>
<html>
<head>
  <base href="../..">
  <title>Rect Unit Tests</title>
  <link rel="import" href="test/testbase.html">

  <link rel="import" href="out/region/rect.html">
  <link rel="import" href="out/service/dragdrop.html">
  <link rel="import" href="out/utils.html">
</head>
<body>
  <pb-r-rect></pb-r-rect>

  <script>
    'use strict';

    (function() {
      var Rect = pb.region.Rect;
      var SmartDroppable = pb.region.Rect.SmartDroppable;
      var DragDrop = pb.service.DragDrop;
      var Utils = pb.Utils;
      var expect = chai.expect;
      var _ = spies.Spies;

      var doc = document.currentScript.ownerDocument;

      describe('Rect', function() {
        describe('$SmartDroppable', function() {
          var el;
          var smartDroppable;

          beforeEach(function(done) {
            el = doc.createElement('div');
            smartDroppable = new SmartDroppable(true);
            done();
          });

          describe('#trigger', function() {
            it('should remove the pb-over class, append the last dragged element, and position it correctly', function() {
              var lastDraggedEl = doc.createElement('div');
              lastDraggedEl.attachedCallback = _.spiedFunction();
              _.spy(lastDraggedEl, 'getBoundingClientRect').overrideReturn({
                left: 56,
                top: 78
              });

              DragDrop.dragStart(lastDraggedEl, 12 /** offsetX */, 34 /** offsetY */);
              _.spy(DragDrop, 'dragEnd');

              el.classList.add('pb-over');

              smartDroppable.trigger(el, {
                clientX: 90,
                clientY: 12
              });

              expect(el.classList.contains('pb-over')).to.be.false();
              expect(Utils.toArray(el.children)).to.be.eql([lastDraggedEl]);
              expect(lastDraggedEl.style.left).to.be.equal('22px');
              expect(lastDraggedEl.style.top).to.be.equal('-100px');
              expect(lastDraggedEl.attachedCallback).calledWith().at.least(1);
              expect(DragDrop.dragEnd).calledWith().at.least(1);
            });
            it('should only remove the pb-over class if there are no last dragged elements', function() {
              el.classList.add('pb-over');

              smartDroppable.trigger(el, {
                clientX: 90,
                clientY: 12
              });

              expect(el.classList.contains('pb-over')).to.be.false();
            });
          });
        });

        afterEach(function(done) {
          _.reset();
          done();
        });
      });
    })();
  </script>
</body>