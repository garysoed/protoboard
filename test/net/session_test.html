<!DOCTYPE html>
<html>
<head>
  <base href="..">
  <title>net.Session Unit Tests</title>

  <link rel="import" href="net/session.html">
  <link rel="import" href="testbase.html">
  <link rel="import" href="third_party/di.html">
</head>
<body>
<script>
DIJS
.constant('pb.net.Rpc', {})
.run(require => {

  const _ = require('pb._');
  const _M = require('pb.spies.Matchers');
  const expect = require('expect');
  const Session = require('pb.net.Session.__ctor__');

  describe('net.Session', () => {
    let fakeRootSync;
    let session;

    beforeEach(() => {
      fakeRootSync = {
        add: () => {},
        sync: () => {}
      };

      session = new Session(fakeRootSync);
    });

    describe('create', () => {
      // TODO(gs): Rewrite with InMemoryIO.
      it('should create a new game with the correct data', done => {
        let gameSync = {
          set: () => {}
        };

        _.spy(fakeRootSync, 'add').overrideReturn(Promise.resolve(gameSync));
        _.spy(gameSync, 'set').overrideReturn(Promise.resolve(gameSync));

        session.create(3, { randomSeed: 1234 })
            .then(value => {
              expect(value).to.equal(gameSync);

              let isObject = _M.isA(Object);
              expect(gameSync.set).calledWith(isObject);

              expect(isObject.matchingArgs[0]).to.eql({
                playerCount: 3,
                players: [],
                state: {
                  randomSeed: 1234
                }
              });

              done();
            });
      });
    });

    describe('join', () => {
      let playerSync;
      let gameSync;

      beforeEach(() => {
        playerSync = {
          set: () => Promise.resolve()
        };
        let playersSync = {
          add: () => Promise.resolve(playerSync)
        };
        gameSync = {
          sync: () => playersSync
        };

        _.spy(fakeRootSync, 'sync').overrideReturn(gameSync);
      });

      it('should join the given game with the correct player data', done => {
        _.spy(playerSync, 'set');

        session.join('gameId', 'Player Name', { role: 'Medic' })
            .then(value => {
              expect(value).to.equal(gameSync);

              let isObject = _M.isA(Object);
              expect(playerSync.set).calledWith(isObject).at.least(1);

              expect(isObject.matchingArgs[0]).to.eql({
                name: 'Player Name',
                state: {
                  role: 'Medic'
                }
              });
              done();
            });
      });
    });

    describe('start', () => {
      let gameSync;

      beforeEach(() => {
        gameSync = {
          get: () => {},
          sync: () => playersSync
        };

        _.spy(fakeRootSync, 'sync').overrideReturn(gameSync);
      });

      it('should return promise that is resolved when there are enough players in the game', done => {
        _.spy(gameSync, 'get').overrideReturn(Promise.resolve({
          playerCount: 2,
          players: [{}, {}]
        }));

        session.start('gameId')
            .then(value => {
              expect(value).to.equal(gameSync);
              done();
            });
      });
    });

    afterEach(() => {
      _.reset();
    });
  });
});
</script>
</body>
