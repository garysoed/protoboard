<!DOCTYPE html>
<html>
<head>
  <base href="..">
  <title>net.SessionService Unit Tests</title>

  <link rel="import" href="net/inmemoryio.html">
  <link rel="import" href="net/sessionservice.html">
  <link rel="import" href="testbase.html">
  <link rel="import" href="testutils.html">
  <link rel="import" href="third_party/di.html">
</head>
<body>
<script>
DIJS
.with('pb.net.IO', require => {
  const InMemoryIO = require('pb.net.InMemoryIO');
  return new InMemoryIO();
})
.run(require => {
  const _ = require('spies.Spies');
  const _M = require('spies.Matchers');
  const expect = require('chai.expect');
  const IO = require('pb.net.IO');
  const Rpc = require('pb.net.RpcService');
  const Session = require('pb.net.SessionService.__ctor__');
  const Sync = require('pb.net.Sync');
  const t = require('pb.t');

  describe('net.SessionService', () => {
    let session;

    beforeEach(() => {
      session = new Session(new Sync('(root)', '/'));
    });

    describe('create', () => {
      it('should create a new game with the correct data', done => {
        session.create(2)
            .then(oldGameSync => {
              return Promise.all([
                oldGameSync,
                session.create(3, { randomSeed: 1234 })
              ]);
            })
            .then(values => {
              let [oldGameSync, newGameSync] = values;
              expect(oldGameSync.id).to.not.equal(newGameSync.id);

              return newGameSync.get();
            })
            .then(gameData => {
              expect(gameData).to.eql({
                playerCount: 3,
                players: [],
                state: {
                  randomSeed: 1234
                }
              });
              done();
            });
      });
    });

    describe('get', () => {
      it('should return the game sync object corresponding to the given ID', () => {
        expect(session.get('gameId').id).to.equal('gameId');
      });
    });

    describe('join', () => {
      beforeEach(done => {
        // Create the gameSync "remotely"
        let gameSync = new Sync('gameId', '/games');
        gameSync.set({
          players: []
        }).then(() => {
          done();
        });
      });

      it('should join the given game with the correct player data', done => {
        let gameSync = new Sync('gameId', '/games');
        session.join(gameSync, 'Player Name', { role: 'Medic' })
            .then(value => {
              expect(value).to.equal(gameSync);
              return gameSync.sync('players').get();
            })
            .then(playersData => {
              expect(playersData[0]).to.eql({
                id: 'Player Name',
                state: {
                  role: 'Medic'
                }
              });
              done();
            });
      });
    });

    describe('start', () => {
      it('should return promise that is resolved when there are enough players in the game', done => {
        let gameSync = new Sync('gameId', '/games');
        gameSync.set({
          playerCount: 2,
          players: [{}, {}]
        })
        .then(() => {
          return session.start(gameSync);
        })
        .then(value => {
          expect(value).to.equal(gameSync);
          done();
        });
      });
    });

    afterEach(() => {
      _.reset();
      t.getPrivateProperty(IO, 'data').clear();
    });
  });
});
</script>
</body>
