<!DOCTYPE html>
<html>
<head>
  <base href=".">
  <title>Protoboard Unit Tests</title>

  <link rel="import" href="protoboard.html">
  <link rel="import" href="testbase.html">
  <link rel="import" href="third_party/di.html">
</head>
<body>
<script>
DIJS
.constant('doc', document.currentScript.ownerDocument)
.constant('DIJS', {
  keys: new Map(),
  require: function(key) {
    return this.keys.get(key);
  },
  run: function(fn) {
    fn(this.require.bind(this));
  }
})
.run(require => {

  const DIJS = require('DIJS');
  const doc = require('doc');
  const InMemoryIO = require('pb.net.InMemoryIO');
  const j = require('jasmine');
  const Protoboard = require('pb.Protoboard.__ctor__');

  describe('Protoboard', () => {
    let bootstrap;
    let io;
    let protoboard;

    beforeEach(() => {
      bootstrap = {
        run: j.createSpy('run').and.returnValue(Promise.resolve(null))
      };
      io = new InMemoryIO();
      protoboard = new Protoboard();

      DIJS.keys.set('pb.Bootstrap', bootstrap);
    });

    it('should correctly setup for new game', () => {
      let setupFn = j.createSpy('setupFn');
      return protoboard
          .withIo(io)
          .forNewGame(2, { randomSeed: 1234 })
          .join('playerId', { name: 'Player 1' })
          .join('playerId2', { name: 'Player 2' })
          .setup(setupFn)
          .run(doc)
          .then(require => {
            const Rpc = require('pb.net.RpcService');
            const TemplateService = require('pb.ui.TemplateService');
            return Promise.all([
              require,
              Rpc.get('/(root)'),
              TemplateService.get('pb_playerCount'),
              TemplateService.get('pb_players'),
              TemplateService.get('pb_state')
            ]);
          })
          .then(values => {
            let [require, root, ...templateData] = values;
            let [templatePlayerCount, templatePlayers, templateState] = templateData;
            const StateService = require('pb.data.StateService');
            const TemplateService = require('pb.ui.TemplateService');

            let expectedPlayers = {
              0: {
                id: 'playerId',
                state: {
                  name: 'Player 1'
                }
              },
              1: {
                id: 'playerId2',
                state: {
                  name: 'Player 2'
                }
              }
            };

            expect(setupFn).toHaveBeenCalledWith(require);

            expect(root).toEqual({
              0: {
                playerCount: 2,
                players: expectedPlayers,
                state: {
                  randomSeed: 1234
                }
              }
            });

            expect(StateService.get('pb_playerCount')).toEqual('2');

            expect(templatePlayerCount).toEqual(['pb_playerCount', 2]);
            expect(templatePlayers).toEqual(['pb_players', expectedPlayers]);
            expect(templateState).toEqual(['pb_state', { randomSeed: 1234 }]);
          });
    });
    it('should correctly setup for existing game', () => {
      let setupFn = j.createSpy('setupFn');

      return Promise.all([
        io.set('/(root)/0', { $index: true, keys: ['playerCount', 'players', 'state'] }),
        io.set('/(root)/0/playerCount', 2),
        io.set('/(root)/0/players', { $index: true, keys: ['0'] }),
        io.set('/(root)/0/players/0', { $index: true, keys: ['id', 'state'] }),
        io.set('/(root)/0/players/0/id', 'playerId'),
        io.set('/(root)/0/players/0/state', { $index: true, keys: ['name'] }),
        io.set('/(root)/0/players/0/state/name', 'Player 1'),
        io.set('/(root)/0/state', { $index: true, keys: ['randomSeed'] }),
        io.set('/(root)/0/state/randomSeed', 1234)
      ])
      .then(() => {
        protoboard.withIo(io)
            .forExistingGame('0')
            .join('playerId2', { name: 'Player 2' })
            .setup(setupFn)
            .run(doc)
            .then(require => {
              const Rpc = require('pb.net.RpcService');
              const TemplateService = require('pb.ui.TemplateService');
              return Promise.all([
                require,
                Rpc.get('/(root)'),
                TemplateService.get('pb_playerCount'),
                TemplateService.get('pb_players'),
                TemplateService.get('pb_state')
              ]);
            })
            .then(values => {
              let [require, root, ...templateData] = values;
              let [templatePlayerCount, templatePlayers, templateState] = templateData;
              const StateService = require('pb.data.StateService');
              const TemplateService = require('pb.ui.TemplateService');

              let expectedPlayers = {
                0: {
                  id: 'playerId',
                  state: {
                    name: 'Player 1'
                  }
                },
                1: {
                  id: 'playerId2',
                  state: {
                    name: 'Player 2'
                  }
                }
              };

              expect(setupFn).toHaveBeenCalledWith(require);

              expect(root).toEqual({
                0: {
                  playerCount: 2,
                  players: expectedPlayers,
                  state: {
                    randomSeed: 1234
                  }
                }
              });

              expect(StateService.get('pb_playerCount')).toEqual('2');

              expect(templatePlayerCount).toEqual(['pb_playerCount', 2]);
              expect(templatePlayers).toEqual(['pb_players', expectedPlayers]);
              expect(templateState).toEqual(['pb_state', { randomSeed: 1234 }]);
            });
      });
    });
  });
});
</script>
</body>
