<!DOCTYPE html>
<html>
<head>
  <base href=".">
  <title>Protoboard Unit Tests</title>

  <link rel="import" href="protoboard.html">
  <link rel="import" href="testbase.html">
  <link rel="import" href="third_party/di.html">
</head>
<body>
  <script>
  DIJS
      .prefix('pb')
      .constant('doc', document.currentScript.ownerDocument)
      .with('Bootstrap', require => {
        const _ = require('/_');
        return {
          run: _.spiedFunction()
        };
      })
      .run(require => {

    const _ = require('/_');
    const doc = require('doc');
    const expect = require('/expect');

    describe.only('Protoboard', () => {
      describe('#run', () => {
        it('should call the setup function before calling Bootstrap', done => {
          Protoboard
              .setup(require => {
              })
              .run()
              .then(require => {
                expect(Bootstrap.run).called().at.least(1);
                done();
              });
        });
        it('should pass the same require and optional in the setup and in the resolve handler', done => {
          let setupFn = _.spiedFunction();
          Protoboard
              .setup((require, optional) => {
                setupFn(require, optional);
              })
              .run()
              .then(require => {
                expect(setupFn).calledWith(require).at.least(1);
                done();
              });
        });
        it('should run Bootstrap on root document if not specified', done => {
          Protoboard
              .setup(require => {
                const Bootstrap = require('pb.Bootstrap');
                _.spy(Bootstrap, 'run').overrideReturn(Promise.resolve());
              })
              .run()
              .then(require => {
                const Bootstrap = require('pb.Bootstrap');

                expect(Bootstrap.run).calledWith(document).at.least(1);
                done();
              });
        });
        it('should run Bootstrap on the specified document', done => {
          Protoboard
              .setup(require => {
                const Bootstrap = require('pb.Bootstrap');
                _.spy(Bootstrap, 'run').overrideReturn(Promise.resolve());
              })
              .run(doc)
              .then(require => {
                const Bootstrap = require('pb.Bootstrap');

                expect(Bootstrap.run).calledWith(doc).at.least(1);
                done();
              });
        });
      });

      afterEach(done => {
        _.reset();
        done();
      });
    });
  });
  </script>
</body>
