<!DOCTYPE html>
<html>
<head>
  <base href="..">
  <title>data.StateService Unit Tests</title>

  <link rel="import" href="data/configservice.html">
  <link rel="import" href="ui/registryservice.html">
  <link rel="import" href="data/stateservice.html">
  <link rel="import" href="testbase.html">
  <link rel="import" href="third_party/di.html">
  <link rel="import" href="third_party/jquery.html">
  <link rel="import" href="utils.html">
</head>
<body>
<script>
DIJS
.with('pb.$registry', require => new (require('pb.ui.RegistryService'))())
.constant('doc', document.currentScript.ownerDocument)
.run(require => {

  const _ = require('spies.Spies');
  const $ = require('pb.JQuery');
  const $registry = require('pb.$registry');

  const Config = require('pb.data.ConfigService');
  const doc = require('doc');
  const expect = require('chai.expect');
  const State = require('pb.data.StateService.__ctor__');
  const Utils = require('pb.Utils');

  describe('data.StateService', () => {
    let state;

    beforeEach(() => {
      state = new State(doc);
    });

    describe('#get', () => {
      it('should use existing pb-state element', () => {
        let key = 'key';
        let value = 'value';
        let el = doc.createElement('pb-state');
        $(el).attr(key, value);
        doc.body.appendChild(el);

        expect(state.get(key)).to.equal(value);
      });
      it('should create pb-state element if it does not exist', () => {
        let key = 'key';
        expect(state.get(key)).to.equal('');
        expect(doc.body.querySelector(`pb-state[${key}]`)).to.exist;
      });
      it('should add the key to an existing pb-state element if it does not exist', () => {
        let key = 'key';
        let el = doc.createElement('pb-state');
        doc.body.appendChild(el);

        expect(state.get(key)).to.equal('');
        expect($(el).attr(key)).to.equal('');
      });
    });
    describe('#put', () => {
      let key = 'key';
      let value = 'value';

      it('should use the existing pb-state element', () => {
        let el = doc.createElement('pb-state');
        $(el).attr(key, value);
        doc.body.appendChild(el);

        state.put(key, value);
        expect($(el).attr(key)).to.equal(value);
      });
      it('should create pb-state element if it does not exist', () => {
        state.put(key, value);
        expect(doc.body.querySelector(`pb-state[${key}=${value}]`)).to.exist;
      });
      it('should add the key to an existing pb-state element if it does not exist', () => {
        let key = 'key';
        let value = 'value';
        let el = doc.createElement('pb-state');
        doc.body.appendChild(el);

        state.put(key, value);
        expect($(el).attr(key)).to.equal(value);
      });
    });

    afterEach(() => {
      Utils.toArray(doc.querySelectorAll('pb-state'))
          .forEach(el => {
            doc.body.removeChild(el);
          });
    });
  });
});
</script>
</body>
