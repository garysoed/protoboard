<!DOCTYPE html>
<html>
<head>
  <base href="../..">
  <title>ability.Shuffleable Unit Tests</title>

  <link rel="import" href="test/testbase.html">

  <link rel="import" href="out/ability/shuffleable.html">
</head>
<body>
  <script>
    'use strict';

    (function() {
      var expect = chai.expect;
      var _ = spies.Spies;
      var Shuffleable = pb.ability.Shuffleable;
      var Utils = pb.Utils;

      var doc = document.currentScript.ownerDocument;

      describe('ability.Shuffleable', function() {
        var el;
        var shuffleable;

        beforeEach(function(done) {
          el = doc.createElement('div');
          shuffleable = new Shuffleable(true);
          done();
        });

        describe('#setDefaultValue', function() {
          it('should set the default value if attribute is not set', function() {
            shuffleable.setDefaultValue(el);
            expect($(el).attr('pb-shuffleable')).to.be.equal('true');
          });
          it('should be noop if the attribute is set', function() {
            $(el).attr('pb-shuffleable', 'false');
            shuffleable.setDefaultValue(el);
            expect($(el).attr('pb-shuffleable')).to.be.equal('false');
          });
        });

        describe('#trigger', function() {
          var children = [];
          var origRandom;

          beforeEach(function(done) {
            children.push(doc.createElement('div'));
            children.push(doc.createElement('a'));
            children.push(doc.createElement('p'));

            children.forEach(function(child) {
              el.appendChild(child);
            });

            // TODO(gs): Use override, once implemented.
            origRandom = Math.random;
            var ordering = [1, 3, 2];
            Math.random = function() { return ordering.pop(); };
            done();
          });

          it('should shuffle if enabled', function() {
            $(el).attr('pb-shuffleable', 'true');
            shuffleable.trigger(el);
            expect(Utils.toArray(el.children)).to.be.eql([children[2], children[0], children[1]]);
          });
          it('should be noop if disabled', function() {
            $(el).attr('pb-shuffleable', 'false');

            _.spy(Math, 'random');
            shuffleable.trigger(el);
            expect(Math.random).called().to.be.equal(0);
          });
          it('should be noop if attribute value is bad', function() {
            $(el).attr('pb-shuffleable', 'invalid');
            
            _.spy(Math, 'random');
            shuffleable.trigger(el);
            expect(Math.random).called().to.be.equal(0);
          });

          afterEach(function(done) {
            Math.random = origRandom;
            done();
          });
        });

        afterEach(function(done) {
          _.reset();
          done();
        });
      });
    })();
  </script>
</body>