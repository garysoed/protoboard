<!DOCTYPE html>
<html>
<head>
  <base href="..">
  <title>ability.Helpable Unit Tests</title>

  <link rel="import" href="ability/abilities.html">
  <link rel="import" href="ability/helpable.html">
  <link rel="import" href="service/config.html">
  <link rel="import" href="service/registry.html">
  <link rel="import" href="testbase.html">
  <link rel="import" href="third_party/di.html">
  <link rel="import" href="trigger/click.html">
  <link rel="import" href="trigger/key.html">
</head>
<body>
  <script>
  DI
      .prefix('pb')
      .with('$registry', { Registry: 'service.=' }, $i => new $i.Registry())
      .constant('doc', document.currentScript.ownerDocument)
      .run(
          {
            expect: '/=',
            _: '/=',
            Abilities: 'ability.=',
            Click: 'trigger.=',
            Config: 'service.=',
            Helpable: 'ability.=',
            Key: 'trigger.=',
            doc: '=',
            t: '=',
            $registry: '='
          },
          $i => {

  describe('ability.Helpable', () => {
    let displayEl;

    beforeEach(done => {
      displayEl = $i.doc.createElement('div');

      $i._.spy($i.doc, 'createElement').overrideReturn(displayEl);
      $i.$registry.register($i.doc, $i.Config);
      $i._.reset($i.doc.createElement);
      done();
    });

    describe('#trigger', () => {
      it('should add the abilities as child of the display element and show the element', () => {
        let ability1 = $i.t.createFakeAbility('ability', new $i.Click());
        let ability2 = $i.t.createFakeAbility('ability2', new $i.Key('a'));
        ability1.isEnabled.overrideReturn(true);
        ability2.isEnabled.overrideReturn(true);

        let helpable = new $i.Helpable();
        let el = $i.doc.createElement('div');
        $i.Abilities.of(el)
            .add(helpable)
            .add(ability1)
            .add(ability2);
        $i.Abilities.init(el);

        helpable.trigger(el);
        let children = displayEl.children;
        $i.expect(children.length).to.be.equal(4);

        $i.expect(children.item(0).innerText).to.be.equal(el.nodeName);
        $i.expect(children.item(1).innerText).to.be.equal(`?: ${helpable.attrName}`);
        $i.expect(children.item(2).innerText).to.be.equal(`Click: ${ability1.attrName}`);
        $i.expect(children.item(3).innerText).to.be.equal(`a: ${ability2.attrName}`);
      });

      it('should not add disabled abilities', () => {
        let ability = $i.t.createFakeAbility('disabled', new $i.Click());
        let helpable = new $i.Helpable();
        let el = $i.doc.createElement('div');
        $i.Abilities.of(el)
            .add(helpable)
            .add(ability);
        $i.Abilities.init(el);

        helpable.trigger(el);
        let children = displayEl.children;
        $i.expect(children.length).to.be.equal(2);

        $i.expect(children.item(0).innerText).to.be.equal(el.nodeName);
        $i.expect(children.item(1).innerText).to.be.equal(`?: ${helpable.attrName}`);
      });
    });

    afterEach(done => {
      $i._.reset();
      done();
    });
  });
  });
  </script>
</body>