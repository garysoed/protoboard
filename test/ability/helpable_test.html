<!DOCTYPE html>
<html>
<head>
  <base href="..">
  <title>ability.Helpable Unit Tests</title>

  <link rel="import" href="ability/abilities.html">
  <link rel="import" href="ability/droppable.html">
  <link rel="import" href="ability/helpable.html">
  <link rel="import" href="data/configservice.html">
  <link rel="import" href="ui/registryservice.html">
  <link rel="import" href="testbase.html">
  <link rel="import" href="third_party/di.html">
  <link rel="import" href="trigger/click.html">
  <link rel="import" href="trigger/key.html">
</head>
<body>
<script>
DIJS
.constant('doc', document.currentScript.ownerDocument)
.with('pb.$registry', require => new (require('pb.ui.RegistryService'))())
.with('pb.ability.Helpable.__displayEl__', require => {
  const doc = require('doc');
  return doc.createElement('div');
})
.run(require => {

  const $registry = require('pb.$registry');
  const Abilities = require('pb.ability.Abilities');
  const Click = require('pb.trigger.Click');
  const Config = require('pb.data.ConfigService');
  const displayEl = require('pb.ability.Helpable.__displayEl__');
  const doc = require('doc');
  const Droppable = require('pb.ability.Droppable');
  const Helpable = require('pb.ability.Helpable');
  const Key = require('pb.trigger.Key');

  describe('ability.Helpable', () => {
    describe('#trigger', () => {
      it('should add the abilities as child of the display element and show the element', () => {
        let ability1 = new Droppable('ability', new Click());
        let ability2 = new Droppable('ability2', new Key('a'));

        spyOn(ability1, 'isEnabled').and.returnValue(true);
        spyOn(ability2, 'isEnabled').and.returnValue(true);

        let helpable = new Helpable();
        let el = doc.createElement('div');
        Abilities.of(el)
            .add(helpable)
            .add(ability1)
            .add(ability2);
        Abilities.init(el);

        helpable.trigger(el);
        let children = displayEl.children;
        expect(children.length).toEqual(4);

        expect(children.item(0).innerText).toEqual(el.nodeName);
        expect(children.item(1).innerText).toEqual(`?: ${helpable.attrName}`);
        expect(children.item(2).innerText).toEqual(`Click: ${ability1.attrName}`);
        expect(children.item(3).innerText).toEqual(`a: ${ability2.attrName}`);
      });

      it('should not add disabled abilities', () => {
        let ability = new Droppable('disabled', new Click());
        let helpable = new Helpable();
        let el = doc.createElement('div');
        Abilities.of(el)
            .add(helpable)
            .add(ability);
        Abilities.init(el);

        helpable.trigger(el);
        let children = displayEl.children;
        expect(children.length).toEqual(2);

        expect(children.item(0).innerText).toEqual(el.nodeName);
        expect(children.item(1).innerText).toEqual(`?: ${helpable.attrName}`);
      });
    });
  });
});
</script>
</body>
