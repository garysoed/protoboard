<!DOCTYPE html>
<html>
<head>
  <base href="../..">
  <title>Abilities Unit Tests</title>
  
  <link rel="import" href="test/testbase.html">
  
  <link rel="import" href="out/ability/abilities.html">
</head>
<body>
  <script>
    'use strict';

    (function() {
      var expect = chai.expect;
      var _ = spies.Spies;
      var _M = spies.Matchers;

      var Abilities = pb.ability.Abilities;
      var HammerWrapper = pb.HammerWrapper;

      var doc = document.currentScript.ownerDocument;

      describe('Abilities', function() {
        describe('#config', function() {
          it('should registers all the abilities and register the correct triggerable', function() {
            var Ctor = function() {};
            Ctor.prototype.addEventListener = _.spiedFunction();
            Ctor.prototype.removeEventListener = _.spiedFunction();
            Ctor.prototype.ownerDocument = doc;
            Ctor.prototype.style = {};

            var ability1 = pb.t.createFakeAbility('ability1');
            var ability2 = pb.t.createFakeAbility('ability2');

            Abilities.config(Ctor, {'pb-click': ability1}, ability2);

            _.spy(HammerWrapper, 'on');

            var el = new Ctor();

            el.createdCallback();
            expect(ability1.setDefaultValue).calledWith(el).at.least(1);
            expect(ability2.setDefaultValue).calledWith(el).at.least(1);

            el.attributeChangedCallback('attr', 'oldValue', 'newValue');
            expect(ability1.attributeChangedCallback)
                .calledWith(el, 'attr', 'oldValue', 'newValue').at.least(1);
            expect(ability2.attributeChangedCallback)
                .calledWith(el, 'attr', 'oldValue', 'newValue').at.least(1);

            el.attachedCallback();
            expect(ability1.attachedCallback).calledWith(el).at.least(1);
            expect(ability2.attachedCallback).calledWith(el).at.least(1);

            var clickHandlerCaptor = _M.isA(Function);
            expect(HammerWrapper.on).calledWith(el, 'singletap', clickHandlerCaptor).at.least(1);

            // Trigger the click and check that the correct ability is triggered.
            clickHandlerCaptor.matchingArgs[0]();
            expect(ability1.trigger).calledWith(el).at.least(1);

            el.detachedCallback();
            expect(ability1.detachedCallback).calledWith(el).at.least(1);
            expect(ability2.detachedCallback).calledWith(el).at.least(1);
          });
        });

        afterEach(function(done) {
          _.reset();
          done();
        });
      });
    })();
  </script>
</body>