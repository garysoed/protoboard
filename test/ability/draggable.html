<!DOCTYPE html>
<html>
<head>
  <base href="../..">
  <title>Draggable Unit Tests</title>
  <link rel="import" href="test/testbase.html">
</head>
<body>
  <script>
    'use strict';

    (function() {
      var expect = chai.expect;
      var _ = spies.Spies;
      var _M = spies.Matchers;
      var Draggable = pb.ability.Draggable;

      var doc = document.currentScript.ownerDocument;

      describe('Draggable', function() {
        var el;
        var child1;
        var child2;

        beforeEach(function(done) {
          el = doc.createElement('div');
          child1 = doc.createElement('div');
          child2 = doc.createElement('div');
          el.appendChild(child1);
          el.appendChild(child2);
          done();
        });

        function expectRegistered() {
          // Check that dragstart listener is registered to both children.
          var dragStartCaptor = _M.isA(Function);
          expect(child1.addEventListener).calledWith('dragstart', dragStartCaptor).at.least(1);
          expect(child2.addEventListener).calledWith('dragstart', dragStartCaptor).at.least(1);
          expect(dragStartCaptor.matchingArgs).to.have.members([dragStartCaptor.matchingArgs[0]]);

          var dragStartHandler = dragStartCaptor.matchingArgs[0];
          var event = {
            dataTransfer: {}
          };

          dragStartHandler(event);

          expect(event.dataTransfer.effectAllowed).to.be.equal('move');
          expect(el.classList.contains('pb-dragged')).to.be.true;

          // Check that dragend listener is registered to both children.
          var dragEndCaptor = _M.isA(Function);
          expect(child1.addEventListener).calledWith('dragend', dragEndCaptor).at.least(1);
          expect(child2.addEventListener).calledWith('dragend', dragEndCaptor).at.least(1);
          expect(dragEndCaptor.matchingArgs).to.have.members([dragEndCaptor.matchingArgs[0]]);

          dragEndCaptor.matchingArgs[0]();

          expect(el.classList.contains('pb-dragged')).to.be.false;
        }

        function getRegisteredHandler(el, eventName) {
          var handlerCaptor = _M.isA(Function);
          expect(child1.addEventListener).calledWith('dragstart', handlerCaptor).at.least(1);
          return handlerCaptor.matchingArgs[0];
        }

        function expectUnregistered(dragStartHandler, dragEndHandler) {
          expect(child1.removeEventListener)
              .calledWith('dragstart', dragStartHandler).at.least(1);
          expect(child1.removeEventListener) .calledWith('dragend', dragEndHandler).at.least(1);

          expect(child2.removeEventListener)
              .calledWith('dragstart', dragStartHandler).at.least(1);
          expect(child2.removeEventListener) .calledWith('dragend', dragEndHandler).at.least(1);

          expect($(child1).attr('draggable')).to.not.exist;
          expect($(child2).attr('draggable')).to.not.exist;
        }

        describe('#setDefaultValue', function() {
          it('should set the value', function() {
            Draggable.setDefaultValue.call(el, true);
            expect($(el).attr('pb-draggable')).to.be.equal('true');
          });
          it('should not do anything if value is already set', function() {
            $(el).attr('pb-draggable', false);
            Draggable.setDefaultValue.call(el)
          });
        });

        describe('#attributeChangedCallback', function() {
          it('should register if set to enabled', function() {
            _.spy(child1, 'addEventListener');
            _.spy(child2, 'addEventListener');

            Draggable.attributeChangedCallback.call(el, 'pb-draggable', 'false', 'true');

            expect($(child1).attr('draggable')).to.be.equal('true');
            expect($(child2).attr('draggable')).to.be.equal('true');

            expectRegistered();
          });
          it('should unregister if set to disabled', function() {
            _.spy(child1, 'addEventListener');
            _.spy(child2, 'addEventListener');

            Draggable.attributeChangedCallback.call(el, 'pb-draggable', 'false', 'true');

            _.spy(child1, 'removeEventListener');
            _.spy(child2, 'removeEventListener');
            
            Draggable.attributeChangedCallback.call(el, 'pb-draggable', 'true', 'false');

            expectUnregistered(
                getRegisteredHandler(child1, 'dragstart'),
                getRegisteredHandler(child1, 'dragend'));
          });
          it('should ignore unsupported attributes', function() {
            _.spy(child1, 'addEventListener');
            _.spy(child2, 'addEventListener');
            _.spy(child1, 'removeEventListener');
            _.spy(child2, 'removeEventListener');

            Draggable.attributeChangedCallback.call(el, 'unsupported-attribute', 'old', 'new');

            expect(child1.addEventListener).called().to.be.equal(0);
            expect(child2.addEventListener).called().to.be.equal(0);
            expect(child1.removeEventListener).called().to.be.equal(0);
            expect(child2.removeEventListener).called().to.be.equal(0);
          });
        });

        describe('#attachedCallback', function() {
          it('should register if enabled', function() {
            $(el).attr('pb-draggable', 'true');

            _.spy(child1, 'addEventListener');
            _.spy(child2, 'addEventListener');

            Draggable.attachedCallback.call(el);

            expectRegistered();
          });
          it('should do nothing if not enabled', function() {
            _.spy(child1, 'addEventListener');
            _.spy(child2, 'addEventListener');
            $(el).attr('pb-draggable', 'false');

            Draggable.attachedCallback.call(el);

            expect(child1.addEventListener).called().to.be.equal(0);
            expect(child2.addEventListener).called().to.be.equal(0);
          });
          it('should do nothing if not specified', function() {
            _.spy(child1, 'addEventListener');
            _.spy(child2, 'addEventListener');

            Draggable.attachedCallback.call(el);

            expect(child1.addEventListener).called().to.be.equal(0);
            expect(child2.addEventListener).called().to.be.equal(0);
          });
        });

        describe('#detachedCallback', function() {
          it('should unregister', function() {
            _.spy(child1, 'addEventListener');
            _.spy(child2, 'addEventListener');

            $(el).attr('pb-draggable', 'true');

            Draggable.attachedCallback.call(el);

            _.spy(child1, 'removeEventListener');
            _.spy(child2, 'removeEventListener');
            
            Draggable.detachedCallback.call(el);

            expectUnregistered(
                getRegisteredHandler(child1, 'dragstart'),
                getRegisteredHandler(child1, 'dragend'));
          });
        });

        afterEach(function(done) {
          _.reset();
          done();
        });
      });
    })();
  </script>
</body>