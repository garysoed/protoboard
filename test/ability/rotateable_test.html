<!DOCTYPE html>
<html>
<head>
  <base href="../..">
  <title>Rotateable Unit Tests</title>

  <link rel="import" href="out/testbase.html">

  <link rel="import" href="out/ability/rotateable.html">
  <link rel="import" href="out/di.html">
  <link rel="import" href="out/utils.html">
</head>
<body>
  <script>
  DI
      .with('doc', () => document.currentScript.ownerDocument)
      .run((expect, _, doc, Rotateable, Utils) => {

  // Private symbols.
  let __setOrientationIndex__ = Utils.getSymbol(Rotateable.prototype, 'setOrientationIndex');

  describe('Rotateable', () => {
    let el;

    beforeEach(done => {
      el = doc.createElement('div');
      done();
    });

    describe('#setDefaultValue', () => {
      it('should set the default value if none is specified', () => {
        let rotateable = new Rotateable([45, 90, 234], 1);

        rotateable.setDefaultValue(el);

        expect($(el).attr('pb-rotateable')).to.be.equal('45 90 234');
        expect($(el).attr('pb-orientation-index')).to.be.equal('1');
      });
      it('should set the default value if pb-rotateable is set to true', () => {
        let rotateable = new Rotateable([23]);
        $(el).attr('pb-rotateable', 'true');

        rotateable.setDefaultValue(el);

        expect($(el).attr('pb-rotateable')).to.be.equal('23');
      });
      it('should do nothing if pb-rotateable is set to values other than true', () => {
        let value = 'somevalue';
        let rotateable = new Rotateable([45]);
        $(el).attr('pb-rotateable', value);

        rotateable.setDefaultValue(el);

        expect($(el).attr('pb-rotateable')).to.be.equal(value);
      });
      it('should do nothing if pb-orientation-index is set', () => {
        let value = '0';
        let rotateable = new Rotateable([45, 75], 1);
        $(el).attr('pb-orientation-index', value);

        rotateable.setDefaultValue(el);

        expect($(el).attr('pb-orientation-index')).to.be.equal(value);
      });
    });

    describe('#attributeChangedCallback', () => {
      let rotateable;

      beforeEach(done => {
        rotateable = new Rotateable();
        done();
      });

      it('should __setOrientationIndex__ if the changed attribute is pb-rotateable', () => {
        $(el).attr('pb-orientation-index', '2');

        _.spy(rotateable, __setOrientationIndex__).overrideReturn();

        rotateable.attributeChangedCallback(el, 'pb-rotateable', '', '1 2 3');
        expect(rotateable[__setOrientationIndex__]).calledWith(el, 2).at.least(1);
      });
      it('should update the style if the changed attribute is pb-orientation-index', () => {
        $(el)
            .attr('pb-rotateable', '12 34 56')
            .attr('pb-orientation-index', '2');

        rotateable.attributeChangedCallback(el, 'pb-orientation-index', '2', '0');
        expect(el.style.transform).to.be.equal('rotateZ(12deg)');
      });
      it('should not throw exception if the changed attribute is not supported', () => {
        rotateable.attributeChangedCallback(el, 'unknown', 'blah', 'bar');
      });
    }); 

    describe('#trigger', () => {
      it('should call __setOrientationIndex__ with increased orientation index', () => {
        $(el).attr('pb-orientation-index', '3');

        let rotateable = new Rotateable();
        _.spy(rotateable, __setOrientationIndex__).overrideReturn();

        rotateable.trigger(el);

        expect(rotateable[__setOrientationIndex__]).calledWith(el, 4).at.least(1);
      });
    });

    describe('#__setOrientationIndex__', () => {
      let rotateable;

      beforeEach(done => {
        rotateable = new Rotateable();
        done();
      });

      it('should set the new index', () => {
        $(el).attr('pb-rotateable', '1 2 3 4');
        rotateable[__setOrientationIndex__](el, 3);
        expect($(el).attr('pb-orientation-index')).to.be.equal('3');
      });
      it('should do nothing if pb-rotateable is empty', () => {
        $(el)
            .attr('pb-rotateable', '')
            .attr('pb-orientation-index', '2');
        rotateable[__setOrientationIndex__](el, 3);
        expect($(el).attr('pb-orientation-index')).to.be.equal('2');
      });
      it('should do nothing if pb-rotateable is set to unsupported value', () => {
        $(el)
            .attr('pb-rotateable', 'unsupported')
            .attr('pb-orientation-index', '2');
        rotateable[__setOrientationIndex__](el, 3);
        expect($(el).attr('pb-orientation-index')).to.be.equal('2');
      });
      it('should handle values that are too large', () => {
        $(el).attr('pb-rotateable', '1 2 3 4');
        rotateable[__setOrientationIndex__](el, 7);
        expect($(el).attr('pb-orientation-index')).to.be.equal('3');
      });
      it('should handle negative values', () => {
        $(el).attr('pb-rotateable', '1 2 3 4');
        rotateable[__setOrientationIndex__](el, -1);
        expect($(el).attr('pb-orientation-index')).to.be.equal('3');
      });
      it('should handle very negative values', () => {
        $(el).attr('pb-rotateable', '1 2 3 4');
        rotateable[__setOrientationIndex__](el, -7);
        expect($(el).attr('pb-orientation-index')).to.be.equal('1');
      });
    });

    afterEach(done => {
      _.reset();
      done();
    });
  });
  });
  </script>
</body>