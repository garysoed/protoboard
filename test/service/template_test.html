<!DOCTYPE html>
<html>
<head>
  <base href="..">
  <title>service.Template Unit Tests</title>

  <link rel="import" href="check.html">
  <link rel="import" href="third_party/di.html">
  <link rel="import" href="service/template.html">
  <link rel="import" href="testbase.html">
</head>
<body>
  <script>
  DI
      .constant('Handlebars', {
        helpers: {},
        registerHelper(name, helper) {
          this.helpers[name] = helper;
        },
        registerPartial() {
          return this;
        }
      })
      .prefix('pb')
      .constant('doc', document.currentScript.ownerDocument)
      .run(
          {
            expect: '/=',
            _: '/=',
            _M: '/=',
            doc: '=',
            Check: '=',
            Handlebars: '/=',
            Template: 'service.='
          },
          $i => {

  describe('service.Template', () => {
    describe('#addPartial', () => {
      it('should register partial to Handlebars', () => {
        let name = 'partialName';
        let el = $i.doc.createElement('div');
        el.innerHTML = '{{&gt; abc}}';

        $i._.spy($i.Handlebars, 'registerPartial');

        $i.Template.addPartial(name, el);
        $i.expect($i.Handlebars.registerPartial).calledWith(name, '{{> abc}}').at.least(1);
      });
    });

    describe('#addData and #get', () => {
      it('should handle adding data before retrieval', done => {
        let name = 'data';
        let data = {};
        $i.Template.addData(name, data);
        $i.Template.get(name)
            .then(result => {
              $i.expect(result).to.be.eql([name, data]);
              done();
            });
      });
      it('should handle adding data after retrieval', done => {
        let name = 'data';
        let data = {};
        $i.Template.get(name)
            .then(result => {
              $i.expect(result).to.be.eql([name, data]);
              done();
            });
        $i.Template.addData(name, data);
      });
    });

    describe('$pb-for helper', () => {
      let forHelper;

      beforeEach(done => {
        forHelper = $i.Handlebars.helpers['pb-for'];
        $i.Handlebars.createFrame = input => input;
        done();
      });

      it('should repeat the inner block a number of times', () => {
        let content = 'content';
        let options = {
          fn: $i._.spiedFunction().overrideReturn(content)
        };

        let result = forHelper.call($i.Handlebars, '0', '5', '2', options);
        $i.expect(result).to.be.equal(content + content + content);

        let isAObject = $i._M.isA(Object);
        $i.expect(options.fn).calledWith($i.Handlebars, isAObject).to.be.equal(3);

        let indexes = isAObject.matchingArgs.map(arg => arg.data.index);
        $i.expect(indexes).to.be.eql([0, 2, 4]);
      });
      it('should default step to 1', () => {
        let content = 'content';
        let options = {
          fn: $i._.spiedFunction().overrideReturn(content)
        };

        let result = forHelper.call($i.Handlebars, '0', '2', options);
        $i.expect(result).to.be.equal(content + content);

        let isAObject = $i._M.isA(Object);
        $i.expect(options.fn).calledWith($i.Handlebars, isAObject).to.be.equal(2);

        let indexes = isAObject.matchingArgs.map(arg => arg.data.index);
        $i.expect(indexes).to.be.eql([0, 1]);
      });
    });

    afterEach(done => {
      $i._.reset();
      done();
    });
  });
  });
  </script>
</body>