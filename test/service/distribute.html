<!DOCTYPE html>
<html>
<head>
  <base href="../..">
  <title>Distribute Unit Tests</title>
  <link rel="import" href="test/testbase.html">
</head>
<body>
  <script>
    'use strict';

    (function() {
      var expect = chai.expect;
      var _ = spies.Spies;

      var doc = document.currentScript.ownerDocument;
      var Distribute = pb.service.Distribute;

      describe('Distribute', function() {
        describe('#begin', function() {
          it('should activate when inactive', function() {
            var source = {
              classList: {
                add: function() {},
                remove: function() {}
              }
            };
            var o = {};
            o.handler = function() {};
            _.spy(o, 'handler');
            _.spy(source.classList, 'add');

            $(Distribute).on(Distribute.EventType.BEGIN, o.handler);
            Distribute.begin(source);

            expect(source.classList.add).calledWith('pb-distribute').at.least(1);
            expect(o.handler).called().at.least(1);
            expect(Distribute.isActive()).to.be.true;
          });
          it('should be noop when active', function() {
            var source = {
              classList: {
                add: function() {},
                remove: function() {}
              }
            };

            Distribute.begin(source);

            var o = {
              handler: function() {}
            };
            _.spy(o, 'handler');

            $(Distribute).on(Distribute.EventType.BEGIN, o.handler);
            Distribute.begin(source);

            expect(o.handler).called().to.be.equal(0);
          });

          afterEach(function(done) {
            Distribute.end();
            done();
          });
        });

        describe('#end', function() {
          var source = {
            classList: {
              add: function() {},
              remove: function() {}
            }
          };

          beforeEach(function(done) {
            Distribute.begin(source);
            done();
          });

          it('should deactivate when active', function() {
            _.spy(source.classList, 'remove');
            var o = {
              handler: function() {}
            };
            _.spy(o, 'handler');
            $(Distribute).on(Distribute.EventType.END, o.handler);
            Distribute.end();

            expect(source.classList.remove).calledWith('pb-distribute').at.least(1);
            expect(o.handler).called().at.least(1);
            expect(Distribute.isActive()).to.be.false;
          });
          it('should be noop when inactive', function() {
            Distribute.end();

            var o = {
              handler: function() {}
            };
            _.spy(o, 'handler');
            $(Distribute).on(Distribute.EventType.END, o.handler);

            Distribute.end();
            expect(o.handler).called().to.be.equal(0);
          });
        });

        describe('#isActive', function() {
          it('should return true iff the distribution is active', function() {
            var source = {
              classList: {
                add: function() {},
                remove: function() {}
              }
            };

            Distribute.begin(source);
            expect(Distribute.isActive()).to.be.true;

            Distribute.end();
            expect(Distribute.isActive()).to.be.false;
          });
        });

        describe('#next', function() {
          it('should return the first child of the source', function() {
            var child = {};
            var source = {
              classList: {
                add: function() {},
                remove: function() {}
              },
              next: function() { return child; }
            };

            Distribute.begin(source);

            expect(Distribute.next()).to.be.equal(child);
          });
        })

        describe('#onkeydown', function() {
          it('should end distribution when ESC is pressed', function() {
            var source = {
              classList: {
                add: function() {},
                remove: function() {}
              }
            };

            Distribute.begin(source);

            _.spy(Distribute, 'end');

            var event = {
              type: 'keydown',
              which: 27
            };
            $(window).trigger(event);
            expect(Distribute.end).calledWith().at.least(1);
          });
          it('should be noop if other key is pressed', function() {
            var source = {
              classList: {
                add: function() {},
                remove: function() {}
              }
            };

            Distribute.begin(source);

            _.spy(Distribute, 'end');

            var event = {
              type: 'keydown',
              which: 20
            };
            $(window).trigger(event);
            expect(Distribute.end).called().to.be.equal(0);

            Distribute.end();
          });
          it('should be noop if is inactive', function() {
            _.spy(Distribute, 'end');

            var event = {
              type: 'keydown',
              which: 27
            };
            $(window).trigger(event);
            expect(Distribute.end).called().to.be.equal(0);
          });
        });

        afterEach(function(done) {
          _.reset();
          done();
        });
      });
    })();
  </script>
</body>