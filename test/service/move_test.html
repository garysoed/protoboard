<!DOCTYPE html>
<html>
<head>
  <base href="..">
  <title>service.Move Unit Tests</title>

  <link rel="import" href="service/move.html">
  <link rel="import" href="service/registry.html">
  <link rel="import" href="testbase.html">
  <link rel="import" href="third_party/di.html">
  <link rel="import" href="third_party/jquery.html">
  <link rel="import" href="utils.html">
</head>
<body>
  <script>
  DI
      .prefix('pb')
      .with('$registry', { Registry: 'service.=' }, $i => new $i.Registry())
      .constant('doc', document.currentScript.ownerDocument)
      .run(
          {
            _: '/=',
            $: '/=',
            $registry: '=',
            doc: '=',
            Events: '=',
            expect: '/=',
            t: '=',
            Move: 'service.=',
            Utils: '=',
          },
          $i => {

  // Private symbols.
  const __container__ = $i.t.getSymbol($i.Move, 'container');
  const __moveContainer__ = $i.t.getSymbol($i.Move, 'moveContainer');
  const __onMouseMove__ = $i.t.getSymbol($i.Move, 'onMouseMove');
  const __onContainerMutation__ = $i.t.getSymbol($i.Move, 'onContainerMutation');

  describe('service.Move', () => {
    before(done => {
      $i.$registry.register($i.doc);
      done();
    });

    beforeEach(done => {
      done();
    });

    describe('__moveContainer__', () => {
      it('should set the left and top coordinates of the container correctly', () => {
        let child1 = $i.doc.createElement('div');
        $i._.spy(child1, 'getBoundingClientRect').overrideReturn({ width: 20, height: 30 });
        let child2 = $i.doc.createElement('div');
        $i._.spy(child2, 'getBoundingClientRect').overrideReturn({ width: 10, height: 40 });

        let container = $i.Move[__container__];
        container.appendChild(child1);
        container.appendChild(child2);

        let x = 55;
        let y = 77;
        $i.Move[__onMouseMove__]({ clientX: x, clientY: y });

        $i.Move[__moveContainer__]();

        $i.expect(container.style.left).to.equal('45px');
        $i.expect(container.style.top).to.equal('57px');
      });
    });

    describe('__onMouseMove__', () => {
      it('should set the mouse coordinates correctly and move the container', () => {
        let event = { clientX: 12, clientY: 24};

        $i._.spy($i.Move, __moveContainer__);

        $i.Move[__onMouseMove__](event);

        $i.expect($i.Move.mouseX).to.equal(event.clientX);
        $i.expect($i.Move.mouseY).to.equal(event.clientY);
        $i.expect($i.Move[__moveContainer__]).calledWith().at.least(1);
      });
    });

    describe('__onContainerMutation__', () => {
      it('should trigger an event if an element is moved out of the container', done => {
        let el = $i.doc.createElement('div');
        let parent = $i.doc.createElement('div');
        let newParent = $i.doc.createElement('div');

        parent.appendChild(el);
        $i.Move.add(el);

        newParent.appendChild(el);
        $i.Events.of($i.Move).on('jquery', $i.Move.Events.MOVE, (event, data) => {
          $i.expect(data.moved).to.equal(el);
          $i.expect(data.from).to.equal(parent);
          $i.expect(data.to).to.equal(newParent);
          done();
        });
        $i.Move[__onContainerMutation__]([{ removedNodes: [el] }]);
      });
      it('should not trigger an event for an element that was not added to the container', function(done) {
        const TIMEOUT = 500;

        let el = $i.doc.createElement('div');
        this.timeout(TIMEOUT);
        setTimeout(done, TIMEOUT - 100);

        $i.Events.of($i.Move).on('jquery', $i.Move.Events.MOVE, () => {
          $i.expect(true).to.be.false();
        });
        $i.Move[__onContainerMutation__]([{ removedNodes: [el] }]);
        $i.Events.of($i.Move).off();
      });
      it('should not trigger an event if the element is returned to the origin source', function(done) {
        const TIMEOUT = 500;

        let el = $i.doc.createElement('div');
        let parent = $i.doc.createElement('div');

        this.timeout(TIMEOUT);
        setTimeout(done, TIMEOUT - 100);

        parent.appendChild(el);
        $i.Move.add(el);

        $i.Events.of($i.Move).on('jquery', $i.Move.Events.MOVE, () => {
          $i.expect(true).to.be.false();
        });

        // Add it back to the old parent.
        parent.appendChild(el);
        $i.Move[__onContainerMutation__]([{ removedNodes: [el] }]);
        $i.Events.of($i.Move).off();
      });
    });

    describe('add', () => {
      it('should add the element to the container and move the container', () => {
        let el = $i.doc.createElement('div');

        $i._.spy($i.Move, __moveContainer__);

        $i.Move.add(el);

        $i.expect($i.Move[__moveContainer__]).calledWith().at.least(1);
        $i.expect($i.Move[__container__].contains(el)).to.be.true();
      });
    });

    describe('get movedElements', () => {
      it('should return a set containing the children', () => {
        let child1 = $i.doc.createElement('div');
        let child2 = $i.doc.createElement('div');

        let container = $i.Move[__container__];
        container.appendChild(child1);
        container.appendChild(child2);

        $i.expect($i.Utils.toArray($i.Move.movedElements)).to.eql([child1, child2]);
      });
    });

    describe('get nextElement', () => {
      it('should return the last added child', () => {
        let child1 = $i.doc.createElement('div');
        let child2 = $i.doc.createElement('div');

        let container = $i.Move[__container__];
        container.appendChild(child1);
        container.appendChild(child2);

        $i.expect($i.Move.nextElement).to.eql(child2);
      });
      it('should return null if there are no children', () => {
        $i.expect($i.Move.nextElement).to.equal(null);
      });
    });

    afterEach(done => {
      $i._.reset();
      $i.Events.of($i.Move).off();
      $i.Move[__container__].innerHTML = '';
      done();
    });
  });
  });
  </script>
</body>
