<!DOCTYPE html>
<html>
<head>
  <base href=".">
  <title>PbElement Unit Tests</title>

  <link rel="import" href="pbelement.html">
  <link rel="import" href="third_party/di.html">
  <link rel="import" href="testbase.html">
</head>
<body>
<script>
DIJS
.constant('doc', document.currentScript.ownerDocument)
.run(require => {

  const _ = require('_');
  const $ = require('$');
  const doc = require('doc');
  const expect = require('expect');
  const PbElement = require('pb.PbElement');

  describe('PbElement', () => {
    describe('#createdCallback', () => {
      let el;
      let pbElement;

      beforeEach(done => {
        el = doc.createElement('div');
        done();
      });

      it('should create id with the given prefix', () => {
        let prefix = 'prefix';
        $(el).attr('pb-id', prefix);

        Object.setPrototypeOf(el, PbElement.prototype);
        el.createdCallback();

        expect($(el).attr('pb-id')).to.be.equal(`${prefix}-0`);
        expect(el.pbId).to.be.equal(`${prefix}-0`);
        expect(el.pbIdPrefix).to.be.equal(prefix);
      });
      it('should increment the number for the second element', () => {
        let prefix = 'prefix2';
        let el2 = doc.createElement('div');

        $(el).attr('pb-id', prefix);
        $(el2).attr('pb-id', prefix);

        Object.setPrototypeOf(el, PbElement.prototype);
        el.createdCallback();

        Object.setPrototypeOf(el2, PbElement.prototype);
        el2.createdCallback();

        expect($(el2).attr('pb-id')).to.be.equal(`${prefix}-1`);
      });
      it('should default the prefix to the element\'s name', () => {
        Object.setPrototypeOf(el, PbElement.prototype);
        el.createdCallback();

        expect($(el).attr('pb-id')).to.be.equal('div-0');
      });
    });
    describe('#whenCreated', () => {
      function createElement() {
        let el = doc.createElement('div');
        Object.setPrototypeOf(el, PbElement.prototype);
        el.createdCallback();
        return el;
      }

      it('should be resolved when the element is attached', done => {
        let el = createElement();
        el.whenCreated.then(() => done());
        el.attachedCallback();
      });
      it('should not be resolved when the element has not been attached', () => {
        createElement().whenCreated.then(() => {
          expect.to.fail();
        });
      });
    });
  });
});
</script>
</body>
