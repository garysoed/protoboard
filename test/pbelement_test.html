<!DOCTYPE html>
<html>
<head>
  <base href=".">
  <title>PbElement Unit Tests</title>

  <link rel="import" href="third_party/di.html">
  <link rel="import" href="testbase.html">
</head>
<body>
  <script>
  DI
      .prefix('pb')
      .constant('doc', document.currentScript.ownerDocument)
      .run(
          {
            expect: '/=',
            _: '/=',
            $: '/=',
            doc: '=',
            PbElement: '='
          },
          $i => {

  describe('PbElement', () => {
    describe('#createdCallback', () => {
      let el;
      let pbElement;

      beforeEach(done => {
        el = $i.doc.createElement('div');
        done();
      });

      it('should create id with the given prefix', () => {
        let prefix = 'prefix';
        $i.$(el).attr('pb-id', prefix);

        Object.setPrototypeOf(el, $i.PbElement.prototype);
        el.createdCallback();

        $i.expect($i.$(el).attr('pb-id')).to.be.equal(`${prefix}-0`);
        $i.expect(el.pbId).to.be.equal(`${prefix}-0`);
        $i.expect(el.pbIdPrefix).to.be.equal(prefix);
      });
      it('should increment the number for the second element', () => {
        let prefix = 'prefix2';
        let el2 = $i.doc.createElement('div');

        $i.$(el).attr('pb-id', prefix);
        $i.$(el2).attr('pb-id', prefix);

        Object.setPrototypeOf(el, $i.PbElement.prototype);
        el.createdCallback();

        Object.setPrototypeOf(el2, $i.PbElement.prototype);
        el2.createdCallback();

        $i.expect($i.$(el2).attr('pb-id')).to.be.equal(`${prefix}-1`);
      });
      it('should default the prefix to the element\'s name', () => {
        Object.setPrototypeOf(el, $i.PbElement.prototype);
        el.createdCallback();

        $i.expect($i.$(el).attr('pb-id')).to.be.equal('div-0');
      });
    });
    describe('#whenCreated', () => {
      function createElement() {
        let el = $i.doc.createElement('div');
        Object.setPrototypeOf(el, $i.PbElement.prototype);
        el.createdCallback();
        return el;
      }

      it('should be resolved when the element is attached', done => {
        let el = createElement();
        el.whenCreated.then(() => done());
        el.attachedCallback();
      });
      it('should not be resolved when the element has not been attached', () => {
        createElement().whenCreated.then(() => {
          expect.to.fail();
        });
      });
    });
  });
  });
  </script>
</body>
